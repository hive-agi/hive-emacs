;;; hive-mcp-addons.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'cl-lib)

(defmacro hive-mcp-addons-with-dep (feature & body)
  "Execute BODY only if FEATURE is available.\nIf FEATURE cannot be loaded, log a message and return nil.\nThis macro is used for graceful degradation when optional\ndependencies are not installed."
  (let* ((err-sym (gensym "feat-")))
    (list 'if (list 'require (list 'quote feature) nil 't) (cons 'progn body) (list 'progn (list 'message "hive-mcp: skipping code requiring %s (not installed)" (list 'symbol-name (list 'quote feature))) nil))))

(defun hive-mcp-addons-addons-dep-available-p (feature)
  "Return non-nil if FEATURE is available (can be required).\nUse this to check for optional dependencies before attempting to use them."
  (require feature nil t))

(defun hive-mcp-addons-addons-check-deps (addon deps)
  "Check if all DEPS are available for ADDON.\nReturns a list of missing dependencies, or nil if all are satisfied.\nDEPS should be a list of feature symbols."
  (let* ((missing nil))
    (dolist (dep deps)
    (unless (require dep nil t)
    (push dep missing)))
    (when missing
    (message "hive-mcp %s: missing dependencies: %s" addon (mapconcat #'symbol-name (nreverse missing) ", ")))
    (nreverse missing)))

(defgroup hive-mcp-addons nil
  "Addon system for hive-mcp."
  :group 'hive-mcp
  :prefix "hive-mcp-addon-")

(defcustom hive-mcp-addon-directories (list (expand-file-name "addons" (file-name-directory (or load-file-name buffer-file-name))))
  "Directories to search for hive-mcp addons."
  :group 'hive-mcp-addons
  :type '(repeat directory))

(defcustom hive-mcp-addon-auto-load-list '((cider . cider) (claude-code . claude-code) (org-ai . org-ai) (org-kanban . org-kanban) (vibe-kanban . vibe-kanban) (swarm . vterm))
  "Alist of (ADDON . TRIGGER-FEATURE).\nWhen TRIGGER-FEATURE is loaded, ADDON will be auto-loaded.\nAddon names correspond to files: hive-mcp-ADDON.el"
  :group 'hive-mcp-addons
  :type '(alist :key-type symbol :value-type symbol))

(defcustom hive-mcp-addon-always-load nil
  "List of addons to always load when `hive-mcp-mode' is enabled.\nThese load regardless of whether the trigger feature is present.\nExample: '(cider org-kanban package-lint)"
  :group 'hive-mcp-addons
  :type '(repeat symbol))

(defvar hive-mcp-addon--registry (make-hash-table :test 'eq)
  "Hash table of registered addons.\nKeys are addon symbols, values are plists with :loaded, :version, :description,\n:init, :async-init, :shutdown, and runtime state.")

(defvar hive-mcp-addon--hooks nil
  "Alist of (FEATURE . ADDON) for deferred loading.")

(defvar hive-mcp-addon--processes (make-hash-table :test 'eq)
  "Hash table tracking async processes started by addons.\nKeys are addon symbols, values are process objects.")

(defvar hive-mcp-addon--timers (make-hash-table :test 'eq)
  "Hash table tracking timers started by addons.\nKeys are addon symbols, values are lists of timer objects.")

(defun hive-mcp-addons---find-file (addon)
  "Find the file for ADDON in addon directories."
  (let* ((filename (format "hive-mcp-%s.el" addon)))
    (cl-some (lambda (dir)
    (let* ((path (expand-file-name filename dir)))
    (when (file-exists-p path)
    path))) hive-mcp-addon-directories)))

(defun hive-mcp-addons-addon-available-p (addon)
  "Return non-nil if ADDON is available (file exists)."
  (hive-mcp-addons--find-file addon))

(defun hive-mcp-addons-addon-loaded-p (addon)
  "Return non-nil if ADDON is already loaded."
  (plist-get (gethash addon hive-mcp-addon--registry) :loaded))

(defun hive-mcp-addons-addon-running-p (addon)
  "Return non-nil if ADDON has active async processes or timers."
  (or (when-let ((proc (gethash addon hive-mcp-addon--processes)))
    (process-live-p proc)) (when-let ((timers (gethash addon hive-mcp-addon--timers)))
    (cl-some #'timerp timers))))

(defun hive-mcp-addons---run-init (addon)
  "Run the :init function for ADDON if defined."
  (when-let ((props (gethash addon hive-mcp-addon--registry)))
    (when-let ((init-fn (plist-get props :init)))
    (condition-case err
    (progn
  (funcall init-fn)
  (message "Emacs-mcp addon %s: init completed" addon))
  (error (message "Emacs-mcp addon %s: init failed: %s" addon (error-message-string err)))))))

(defun hive-mcp-addons---run-async-init (addon)
  "Run the :async-init function for ADDON if defined.\nThe async-init function should return a process object or nil."
  (when-let ((props (gethash addon hive-mcp-addon--registry)))
    (when-let ((async-init-fn (plist-get props :async-init)))
    (condition-case err
    (let* ((result (funcall async-init-fn)))
    (when (processp result)
    (puthash addon result hive-mcp-addon--processes))
    (message "Emacs-mcp addon %s: async-init started" addon))
  (error (message "Emacs-mcp addon %s: async-init failed: %s" addon (error-message-string err)))))))

(defun hive-mcp-addons---run-shutdown (addon)
  "Run the :shutdown function for ADDON if defined."
  (when-let ((props (gethash addon hive-mcp-addon--registry)))
    (when-let ((shutdown-fn (plist-get props :shutdown)))
    (condition-case err
    (progn
  (funcall shutdown-fn)
  (message "Emacs-mcp addon %s: shutdown completed" addon))
  (error (message "Emacs-mcp addon %s: shutdown failed: %s" addon (error-message-string err)))))))

(defun hive-mcp-addons---cleanup (addon)
  "Clean up processes and timers for ADDON."
  (when-let ((proc (gethash addon hive-mcp-addon--processes)))
    (when (process-live-p proc)
    (kill-process proc))
    (remhash addon hive-mcp-addon--processes))
  (when-let ((timers (gethash addon hive-mcp-addon--timers)))
    (dolist (timer timers)
    (when (timerp timer)
    (cancel-timer timer)))
    (remhash addon hive-mcp-addon--timers)))

(defun hive-mcp-addons-addon-register-process (addon process)
  "Register PROCESS as belonging to ADDON for lifecycle management."
  (puthash addon process hive-mcp-addon--processes))

(defun hive-mcp-addons-addon-register-timer (addon timer)
  "Register TIMER as belonging to ADDON for lifecycle management."
  (let* ((existing (gethash addon hive-mcp-addon--timers)))
    (puthash addon (cons timer existing) hive-mcp-addon--timers)))

(defun hive-mcp-addons-addon-unregister-timer (addon timer)
  "Unregister TIMER from ADDON."
  (when-let ((timers (gethash addon hive-mcp-addon--timers)))
    (puthash addon (delq timer timers) hive-mcp-addon--timers)))

(defun hive-mcp-addons-addon-load (addon)
  "Load ADDON if available and not already loaded.\nAfter loading, runs :init (sync) then :async-init (non-blocking).\nReturns t if loaded successfully, nil otherwise."
  (interactive (list (intern (completing-read "Load addon: " (hive-mcp-addon-list-available) nil t))))
  (cond
  ((hive-mcp-addons-addon-loaded-p addon) (progn
  (message "Addon %s already loaded" addon)
  t))
  ((hive-mcp-addons--find-file addon) (let* ((file (hive-mcp-addons--find-file addon)))
    (load file nil t)
    (puthash addon (plist-put (gethash addon hive-mcp-addon--registry) :loaded t) hive-mcp-addon--registry)
    (hive-mcp-addons--run-init addon)
    (hive-mcp-addons--run-async-init addon)
    (message "Loaded hive-mcp addon: %s" addon)
    t))
  (t (progn
  (message "Addon %s not found" addon)
  nil))))

(defun hive-mcp-addons-addon-unload (addon)
  "Unload ADDON, running shutdown hooks and cleaning up resources."
  (interactive (list (intern (completing-read "Unload addon: " (hive-mcp-addon-list-loaded) nil t))))
  (when (hive-mcp-addons-addon-loaded-p addon)
    (hive-mcp-addons--run-shutdown addon)
    (hive-mcp-addons--cleanup addon)
    (puthash addon (plist-put (gethash addon hive-mcp-addon--registry) :loaded nil) hive-mcp-addon--registry)
    (message "Unloaded hive-mcp addon: %s" addon)
    t))

(defun hive-mcp-addons-addon-restart (addon)
  "Restart ADDON by unloading and reloading it."
  (interactive (list (intern (completing-read "Restart addon: " (hive-mcp-addon-list-loaded) nil t))))
  (hive-mcp-addons-addon-unload addon)
  (hive-mcp-addons-addon-load addon))

(defun hive-mcp-addons-addon-list-available ()
  "Return list of available addon symbols."
  (let* ((addons nil))
    (dolist (dir hive-mcp-addon-directories)
    (when (file-directory-p dir)
    (dolist (file (directory-files dir nil "^hive-mcp-.*\\.el$"))
    (when (string-match "^hive-mcp-\\(.+\\)\\.el$" file)
    (push (intern (match-string 1 file)) addons)))))
    (delete-dups addons)))

(defun hive-mcp-addons-addon-list-loaded ()
  "Return list of loaded addon symbols."
  (let* ((loaded nil))
    (maphash (lambda (addon props)
    (when (plist-get props :loaded)
    (push addon loaded))) hive-mcp-addon--registry)
    loaded))

(defun hive-mcp-addons---after-load-hook (feature)
  "Hook function to auto-load addons when FEATURE is loaded."
  (dolist (entry hive-mcp-addon-auto-load-list)
    (when (eq (cdr entry) feature)
    (hive-mcp-addons-addon-load (car entry)))))

(defun hive-mcp-addons-addons-auto-load ()
  "Enable auto-loading of addons when their trigger packages load.\nUses `hive-mcp-addon-auto-load-list' to determine mappings.\nThis function is called during initialization; for manual setup,\nusers can also configure auto-loading in their init file."
  (interactive)
  (dolist (entry hive-mcp-addon-auto-load-list)
    (let* ((addon (car entry))
        (trigger (cdr entry)))
    (if (featurep trigger) (hive-mcp-addons-addon-load addon) (eval-after-load trigger (clel-seq (clel-concat (clojure-core-list 'user/hive-mcp-addons-addon-load) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'quote) (clojure-core-list 'user/addon)))))))))))

(defun hive-mcp-addons-addons-load-always ()
  "Load all addons in `hive-mcp-addon-always-load'.\nCalled during `hive-mcp-initialize' to load user's preferred addons."
  (interactive)
  (dolist (addon hive-mcp-addon-always-load)
    (hive-mcp-addons-addon-load addon)))

(defun hive-mcp-addons-addons-setup ()
  "Set up addon system: load always-load addons and enable auto-loading.\nThis is the main entry point, called from `hive-mcp-initialize'."
  (interactive)
  (hive-mcp-addons-addons-load-always)
  (hive-mcp-addons-addons-auto-load))

(defun hive-mcp-addons-addon-register (&rest args)
  (let ((addon (nth 0 args)) (props (nthcdr 1 args)))
    "Register ADDON with PROPS.\nPROPS is a plist that may contain:\n\nMetadata:\n  :version     - Version string\n  :description - One-line description\n  :requires    - List of required features\n  :provides    - List of provided features/commands\n\nLifecycle hooks:\n  :init        - Function to run synchronously after loading.\n                 Use for lightweight setup that must complete before use.\n\n  :async-init  - Function to run asynchronously after loading.\n                 Should return a process object if starting a subprocess.\n                 Use for long-running startup (e.g., starting nREPL, npx).\n                 Non-blocking - does not delay Emacs startup.\n\n  :shutdown    - Function to run when unloading the addon.\n                 Use for cleanup (stopping servers, saving state).\n\nExample:\n  (hive-mcp-addon-register\n   'my-addon\n   :version \"1.0.0\"\n   :description \"My cool addon\"\n   :init #'my-addon-setup-keybindings\n   :async-init #'my-addon-start-server\n   :shutdown #'my-addon-stop-server)"
  (puthash addon props hive-mcp-addon--registry)))

(defun hive-mcp-addons-addon-info ()
  "Display information about available and loaded addons."
  (interactive)
  (let* ((buf (get-buffer-create "*hive-mcp addons*")))
    (with-current-buffer buf
    (erase-buffer)
    (insert "=== hive-mcp Addons ===\n\n")
    (insert "Available addons:\n")
    (dolist (addon (hive-mcp-addons-addon-list-available))
    (let* ((loaded (hive-mcp-addons-addon-loaded-p addon))
        (running (hive-mcp-addons-addon-running-p addon))
        (props (gethash addon hive-mcp-addon--registry))
        (has-init (plist-get props :init))
        (has-async (plist-get props :async-init))
        (has-shutdown (plist-get props :shutdown)))
    (insert (format "  %s%s %s\n" (if loaded "[loaded]" "[      ]") (if running "*" " ") addon))
    (when-let ((desc (plist-get props :description)))
    (insert (format "           %s\n" desc)))
    (when (or has-init has-async has-shutdown)
    (insert (format "           lifecycle: %s%s%s\n" (if has-init "init " "") (if has-async "async-init " "") (if has-shutdown "shutdown" ""))))))
    (insert "\n")
    (insert "Legend: [loaded] = loaded, * = has running process/timer\n\n")
    (insert "Addon directories:\n")
    (dolist (dir hive-mcp-addon-directories)
    (insert (format "  %s\n" dir)))
    (goto-char (point-min)))
    (display-buffer buf)))

(provide 'hive-mcp-addons)

(provide 'hive-mcp-addons)
;;; hive-mcp-addons.el ends here
