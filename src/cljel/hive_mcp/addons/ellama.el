;;; hive-mcp-ellama.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'cl-lib)
(require 'subr-x)

;;; Code:



(declare-function ellama-chat "ellama")

(declare-function ellama-stream "ellama")

(declare-function ellama-complete "ellama")

(declare-function ellama-provider-ollama "llm-ollama")

(declare-function make-llm-ollama "llm-ollama")

(declare-function hive-mcp-ai-build-context "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-inject-context "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-store-response "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-log-interaction "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-dispatch-to-swarm "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-run-post-response-hooks "hive-mcp-ai-bridge")

(declare-function hive-mcp-ai-format-context-for "hive-mcp-ai-bridge")

(declare-function hive-mcp-api-call "hive-mcp-api")

(defvar ellama-provider nil)

(defvar ellama-chat-done-callback nil)

(defgroup hive-mcp-ellama nil
  "Integration between hive-mcp and ellama/Ollama."
  :group 'hive-mcp
  :prefix "hive-mcp-ellama-")

(defcustom hive-mcp-ellama-default-model "devstral"
  "Default Ollama model for inference and swarm workers."
  :group 'hive-mcp-ellama
  :type 'string)

(defcustom hive-mcp-ellama-models '(("devstral" . "Best quality coding - Mistral's dev model") ("devstral-small" . "Fast, good enough for simple tasks") ("deepseek-r1:7b" . "Reasoning tasks with chain-of-thought"))
  "Available Ollama models with descriptions.\nEach entry is (MODEL-NAME . DESCRIPTION)."
  :group 'hive-mcp-ellama
  :type '(alist :key-type string :value-type string))

(defcustom hive-mcp-ellama-inject-context t
  "When non-nil, inject memory context into ellama prompts."
  :group 'hive-mcp-ellama
  :type 'boolean)

(defcustom hive-mcp-ellama-include-semantic t
  "When non-nil, include semantic search in context injection."
  :group 'hive-mcp-ellama
  :type 'boolean)

(defcustom hive-mcp-ellama-store-responses t
  "When non-nil, store notable ellama responses to memory."
  :group 'hive-mcp-ellama
  :type 'boolean)

(defcustom hive-mcp-ellama-log-interactions t
  "When non-nil, log ellama interactions for audit trail."
  :group 'hive-mcp-ellama
  :type 'boolean)

(defcustom hive-mcp-ellama-context-prefix "\n\n---\n## Project Context\n\n"
  "Prefix added before injected context."
  :group 'hive-mcp-ellama
  :type 'string)

(defcustom hive-mcp-ellama-ollama-host "localhost"
  "Ollama server host."
  :group 'hive-mcp-ellama
  :type 'string)

(defcustom hive-mcp-ellama-ollama-port 11434
  "Ollama server port."
  :group 'hive-mcp-ellama
  :type 'integer)

(defvar hive-mcp-ellama--initialized nil)

(defvar hive-mcp-ellama--last-prompt nil)

(defvar hive-mcp-ellama--workers (make-hash-table :test 'equal)
  "Hash table of active Ollama swarm workers.\nKey: worker-id, Value: plist with :model :buffer :status :task")

(defun hive-mcp-ellama--ensure-bridge ()
  "Ensure hive-mcp-ai-bridge is available."
  (or (featurep 'hive-mcp-ai-bridge) (require 'hive-mcp-ai-bridge nil t)))

(defun hive-mcp-ellama--ensure-ellama ()
  "Ensure ellama is available."
  (or (featurep 'ellama) (require 'ellama nil t)))

(defun hive-mcp-ellama--ensure-llm-ollama ()
  "Ensure llm-ollama is available for provider creation."
  (or (featurep 'llm-ollama) (require 'llm-ollama nil t)))

(defun hive-mcp-ellama-make-provider (&optional model)
  "Create an Ollama provider for MODEL.\nMODEL defaults to `hive-mcp-ellama-default-model'.\nIncludes num_ctx for larger context windows."
  (when (-ensure-llm-ollama)
    (make-llm-ollama :chat-model (or model hive-mcp-ellama-default-model) :host hive-mcp-ellama-ollama-host :port hive-mcp-ellama-ollama-port :embedding-model "nomic-embed-text" :default-chat-non-standard-params '(("num_ctx" . 32768)))))

(defun hive-mcp-ellama--build-context-prompt (prompt)
  "Build a prompt with context injected.\nPROMPT is the original user prompt."
  (if (and hive-mcp-ellama-inject-context (-ensure-bridge)) (let* ((context (hive-mcp-ai-build-context (when hive-mcp-ellama-include-semantic
    prompt))))
    (if context (clel-concat (hive-mcp-ai-format-context-for 'ellama context) hive-mcp-ellama-context-prefix prompt) prompt)) prompt))

(defun hive-mcp-ellama--handle-response (response)
  "Handle ellama RESPONSE after completion."
  (when (-ensure-bridge)
    (when hive-mcp-ellama-log-interactions
    (hive-mcp-ai-log-interaction "ellama" "response" (list :prompt-length (length (or hive-mcp-ellama--last-prompt "")) :response-length (length response) :model hive-mcp-ellama-default-model)))
    (when hive-mcp-ellama-store-responses
    (hive-mcp-ai-store-response response "ellama"))
    (hive-mcp-ai-run-post-response-hooks "ellama" response)))

(defun hive-mcp-ellama-dispatch (prompt &optional model callback)
  "Send PROMPT to Ollama via llm-chat-async.\nMODEL overrides `hive-mcp-ellama-default-model'.\nCALLBACK is called with the response when complete.\nUses llm-chat-async directly for reliable model selection."
  (interactive "sPrompt: ")
  (when (-ensure-llm-ollama)
    (setq hive-mcp-ellama--last-prompt prompt)
    (let* ((provider (make-provider model)))
    (llm-chat-async provider (llm-make-chat-prompt prompt) (lambda (response)
    (-handle-response response)
    (when callback
    (funcall callback response))) (lambda (err)
    (message "[hive-mcp-ellama] Error: %s" err))))))

(defun hive-mcp-ellama-dispatch-with-context (prompt &optional model callback)
  "Send PROMPT to Ollama with memory context injected.\nMODEL overrides `hive-mcp-ellama-default-model'.\nCALLBACK is called with the response when complete."
  (interactive "sPrompt: ")
  (let* ((augmented-prompt (-build-context-prompt prompt)))
    (dispatch augmented-prompt model callback)))

(defun hive-mcp-ellama-select-model ()
  "Interactively select an Ollama model."
  (interactive)
  (let* ((choices (mapcar (lambda (m)
    (format "%s - %s" (car m) (cdr m))) hive-mcp-ellama-models))
        (choice (completing-read "Model: " choices nil t))
        (model (car (split-string choice " - "))))
    (setq hive-mcp-ellama-default-model model)
    (message "Switched to model: %s" model)))

(defun hive-mcp-ellama-swarm-spawn (worker-id name &optional model)
  "Spawn an Ollama swarm worker with WORKER-ID and NAME.\nMODEL overrides `hive-mcp-ellama-default-model'.\nReturns the worker-id on success."
  (let* ((actual-model (or model hive-mcp-ellama-default-model)))
    (puthash worker-id (list :worker-id worker-id :name name :model actual-model :status 'idle :task nil :result nil :spawned-at (format-time-string "%FT%T%z")) hive-mcp-ellama--workers)
    (message "[ellama-swarm] Spawned worker %s with model %s" worker-id actual-model)
    worker-id))

(defun hive-mcp-ellama-swarm-dispatch (worker-id prompt &optional callback)
  "Dispatch PROMPT to Ollama swarm WORKER-ID.\nCALLBACK is called with the result when complete.\nReturns a task-id."
  (let* ((worker (gethash worker-id hive-mcp-ellama--workers))
        (model (plist-get worker :model))
        (task-id (format "ollama-task-%s-%d" worker-id (floor (float-time)))))
    (unless worker
    (error "Worker not found: %s" worker-id))
    (plist-put worker :status 'working)
    (plist-put worker :task task-id)
    (dispatch-with-context prompt model (lambda (response)
    (plist-put worker :status 'idle)
    (plist-put worker :result response)
    (plist-put worker :task nil)
    (when callback
    (funcall callback response))))
    task-id))

(defun hive-mcp-ellama-swarm-status ()
  "Get status of all Ollama swarm workers."
  (let* ((workers '()))
    (maphash (lambda (id worker)
    (push (list :worker-id id :name (plist-get worker :name) :model (plist-get worker :model) :status (plist-get worker :status) :task (plist-get worker :task)) workers)) hive-mcp-ellama--workers)
    (list :total (hash-table-count hive-mcp-ellama--workers) :workers (nreverse workers))))

(defun hive-mcp-ellama-swarm-kill (worker-id)
  "Kill Ollama swarm worker WORKER-ID."
  (remhash worker-id hive-mcp-ellama--workers)
  (message "[ellama-swarm] Killed worker %s" worker-id))

(defun hive-mcp-ellama-swarm-kill-all ()
  "Kill all Ollama swarm workers."
  (let* ((count (hash-table-count hive-mcp-ellama--workers)))
    (clrhash hive-mcp-ellama--workers)
    (message "[ellama-swarm] Killed %d workers" count)))

(defun hive-mcp-ellama--tool-read (path)
  "Read file at PATH via MCP.\nUsed by Ollama workers for file operations."
  (when (fboundp 'hive-mcp-api-call)
    (hive-mcp-api-call "read_file" (clel-seq (clel-concat (clojure-core-list :path) (clojure-core-list 'user/path))))))

(defun hive-mcp-ellama--tool-edit (path old-string new-string)
  "Edit file at PATH, replacing OLD-STRING with NEW-STRING via MCP."
  (when (fboundp 'hive-mcp-api-call)
    (hive-mcp-api-call "file_edit" (clel-seq (clel-concat (clojure-core-list :file_path) (clojure-core-list 'user/path) (clojure-core-list :old_string) (clojure-core-list 'user/old-string) (clojure-core-list :new_string) (clojure-core-list 'user/new-string))))))

(defun hive-mcp-ellama--tool-bash (command)
  "Run shell COMMAND via MCP."
  (when (fboundp 'hive-mcp-api-call)
    (hive-mcp-api-call "bash" (clel-seq (clel-concat (clojure-core-list :command) (clojure-core-list 'user/command))))))

(defun hive-mcp-ellama-chat-with-context ()
  "Start ellama chat with memory context injection."
  (interactive)
  (let* ((prompt (clel-read-string "Chat with context: ")))
    (dispatch-with-context prompt)))

(defun hive-mcp-ellama-query-memory (query)
  "Query memory with QUERY and insert results at point."
  (interactive "sQuery memory: ")
  (when (-ensure-bridge)
    (let* ((results (hive-mcp-ai-build-context query)))
    (if results (insert results) (message "No relevant memory found")))))

(defun hive-mcp-ellama-store-region (beg end)
  "Store region between BEG and END as memory snippet."
  (interactive "r")
  (when (-ensure-bridge)
    (let* ((content (buffer-substring-no-properties beg end)))
    (hive-mcp-ai-store-response content "ellama-manual" '("user-selected"))
    (message "Stored selection to memory"))))

(defun hive-mcp-ellama--setup ()
  "Set up ellama integration."
  (when (-ensure-ellama)
    (unless (bound-and-true-p ellama-provider)
    (setq ellama-provider (make-provider)))
    (advice-add 'ellama-chat :around #'-chat-advice)))

(defun hive-mcp-ellama--teardown ()
  "Tear down ellama integration."
  (advice-remove 'ellama-chat #'-chat-advice))

(defun hive-mcp-ellama--chat-advice (orig-fun prompt &rest args)
  "Advice for ellama-chat to inject context.\nORIG-FUN is the original function, PROMPT is the user prompt, ARGS are extra args."
  (setq hive-mcp-ellama--last-prompt prompt)
  (let* ((augmented (if hive-mcp-ellama-inject-context (-build-context-prompt prompt) prompt)))
    (apply orig-fun augmented args)))

(define-minor-mode hive-mcp-ellama-mode
  "Minor mode for hive-mcp integration with ellama/Ollama.\n\nWhen enabled:\n- Memory context is injected into prompts before sending\n- Notable responses are stored to memory\n- Interactions are logged for audit\n- Swarm backend available for two-tier orchestration"
  :init-value nil
  :lighter " MCP-ELL"
  :global t
  :group 'hive-mcp-ellama
  (if hive-mcp-ellama-mode (progn
  (-setup)
  (setq hive-mcp-ellama--initialized t)
  (message "hive-mcp-ellama: enabled")) (-teardown)))

(with-eval-after-load 'transient
  (transient-define-prefix hive-mcp-ellama-menu (nil) "MCP integration menu for ellama/Ollama." (list "hive-mcp + ellama" (list "Chat" ("c" "Chat with context" hive-mcp-ellama-chat-with-context) ("q" "Query memory" hive-mcp-ellama-query-memory) ("m" "Select model" hive-mcp-ellama-select-model)) (list "Store" ("s" "Store region" hive-mcp-ellama-store-region)) (list "Swarm" ("S" "Swarm status" (lambda (_unused)
    (interactive)
    (message "%s" (swarm-status)))) ("K" "Kill all workers" hive-mcp-ellama-swarm-kill-all)) (list "Toggle" ("t" "Toggle mode" hive-mcp-ellama-mode)))))

(defun hive-mcp-ellama--addon-init ()
  "Initialize ellama addon."
  (require 'hive-mcp-ai-bridge nil t)
  (message "hive-mcp-ellama: initialized"))

(defun hive-mcp-ellama--addon-shutdown ()
  "Shutdown ellama addon."
  (when hive-mcp-ellama-mode
    (hive-mcp-ellama-mode -1))
  (swarm-kill-all)
  (message "hive-mcp-ellama: shutdown complete"))

(with-eval-after-load 'hive-mcp-addons
  (hive-mcp-addon-register 'ellama :version "0.1.0" :description "Ollama integration via ellama for two-tier swarm" :requires '(hive-mcp-ai-bridge) :provides '(hive-mcp-ellama-mode) :init #'-addon-init :shutdown #'-addon-shutdown))

(provide 'hive-mcp-ellama)
;;; hive-mcp-ellama.el ends here
