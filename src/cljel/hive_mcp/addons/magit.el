;;; hive-mcp-magit.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'hive-mcp-api)

;;; Code:



(declare-function magit-toplevel "magit-git")

(declare-function magit-get-current-branch "magit-git")

(declare-function magit-get-upstream-branch "magit-git")

(declare-function magit-list-local-branch-names "magit-git")

(declare-function magit-list-remote-branch-names "magit-git")

(declare-function magit-stage-modified "magit-apply")

(declare-function magit-unstage-all "magit-apply")

(declare-function magit-refresh "magit-mode")

(declare-function magit-status "magit-status")

(declare-function hive-mcp-addon-register "hive-mcp-addons")

(declare-function transient-define-prefix "transient")

(defgroup hive-mcp-magit nil
  "Magit integration for hive-mcp."
  :group 'magit
  :prefix "hive-mcp-magit-")

(defcustom hive-mcp-magit-log-count 10
  "Default number of commits to show in log operations."
  :group 'hive-mcp-magit
  :type 'integer)

(defcustom hive-mcp-magit-diff-context-lines 3
  "Number of context lines to show in diffs."
  :group 'hive-mcp-magit
  :type 'integer)

(defcustom hive-mcp-magit-prefer-magit t
  "When non-nil, prefer Magit functions over shell commands."
  :group 'hive-mcp-magit
  :type 'boolean)

(defvar hive-mcp-magit--last-operation nil)

(defun hive-mcp-magit---magit-available-p ()
  "Return non-nil if Magit is available and preferred."
  (and hive-mcp-magit-prefer-magit (featurep 'magit) (fboundp 'magit-toplevel)))

(defun hive-mcp-magit---repo-root ()
  "Return the git repository root directory."
  (if (-magit-available-p) (magit-toplevel) (let* ((root (locate-dominating-file default-directory ".git")))
    (when root
    (expand-file-name root)))))

(defun hive-mcp-magit---ensure-repo ()
  "Ensure we are in a git repository."
  (unless (-repo-root)
    (error "Not in a git repository")))

(defun hive-mcp-magit---shell-command (cmd)
  "Execute git CMD and return trimmed output."
  (let* ((default-directory (or (-repo-root) default-directory)))
    (string-trim (shell-command-to-string cmd))))

(defun hive-mcp-magit---shell-lines (cmd)
  "Execute git CMD and return list of output lines."
  (let* ((output (-shell-command cmd)))
    (unless (string-empty-p output)
    (split-string output "\n" t))))

(defun hive-mcp-magit---get-staged-files ()
  "Return list of staged files."
  (-shell-lines "git diff --cached --name-only 2>/dev/null"))

(defun hive-mcp-magit---get-unstaged-files ()
  "Return list of unstaged modified files."
  (-shell-lines "git diff --name-only 2>/dev/null"))

(defun hive-mcp-magit---get-untracked-files ()
  "Return list of untracked files."
  (-shell-lines "git ls-files --others --exclude-standard 2>/dev/null"))

(defun hive-mcp-magit---get-current-branch ()
  "Return current branch name."
  (if (-magit-available-p) (magit-get-current-branch) (-shell-command "git rev-parse --abbrev-ref HEAD 2>/dev/null")))

(defun hive-mcp-magit---get-upstream-branch ()
  "Return upstream tracking branch."
  (if (-magit-available-p) (magit-get-upstream-branch) (let* ((result (-shell-command "git rev-parse --abbrev-ref @{upstream} 2>/dev/null")))
    (unless (string-empty-p result)
    result))))

(defun hive-mcp-magit---get-stash-list ()
  "Return list of stashes."
  (-shell-lines "git stash list --oneline 2>/dev/null"))

(provide 'hive-mcp-magit)
;;; hive-mcp-magit.el ends here
