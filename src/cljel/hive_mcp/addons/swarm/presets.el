;;; hive-mcp-swarm-presets.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'cl-lib)

(declare-function hive-mcp-memory-query "hive-mcp-memory")

(defgroup hive-mcp-swarm-presets nil
  "Preset management for swarm."
  :group 'hive-mcp-swarm
  :prefix "hive-mcp-swarm-presets-")

(defcustom hive-mcp-swarm-presets-dir (let* [this-file (or load-file-name buffer-file-name default-directory) project-root (locate-dominating-file this-file "deps.edn")] (if project-root (expand-file-name "presets" project-root) (expand-file-name "../../../presets" (file-name-directory this-file))))
  "Directory containing built-in preset markdown files."
  :group 'hive-mcp-swarm-presets
  :type 'directory)

(defcustom hive-mcp-swarm-presets-custom-dirs nil
  "List of custom directories to scan for preset .md files.\nDirectories are scanned recursively for .md files only."
  :group 'hive-mcp-swarm-presets
  :type '(repeat directory))

(defcustom hive-mcp-swarm-presets-use-chroma t
  "Whether to use Chroma vector DB for preset lookup.\nWhen non-nil, presets are first searched in Chroma, with file/memory fallback."
  :group 'hive-mcp-swarm-presets
  :type 'boolean)

(defcustom hive-mcp-swarm-presets-chroma-timeout 5
  "Timeout in seconds for Chroma preset queries."
  :group 'hive-mcp-swarm-presets
  :type 'integer)

(defcustom hive-mcp-swarm-default-presets '("ling" "mcp-first" "hivemind")
  "Default presets applied to all spawned swarm slaves."
  :group 'hive-mcp-swarm-presets
  :type '(repeat string))

(defcustom hive-mcp-swarm-presets-lazy-mode nil
  "When non-nil, inject preset names + query instructions instead of full content.\nLings fetch preset content on-demand via MCP tools."
  :group 'hive-mcp-swarm-presets
  :type 'boolean)

(defvar hive-mcp-swarm-presets--cache nil)

(defconst hive-mcp-swarm-presets--auto-shout-footer "\n\n---\n\n## MANDATORY: Task Completion Protocol\n\n**CRITICAL**: When you complete your assigned task, you MUST immediately call:\n\n```\nhivemind_shout(event_type: \"completed\", task: \"<your task summary>\", message: \"<brief result summary>\")\n```\n\nThis is NON-NEGOTIABLE. The coordinator cannot see your work until you shout completion.\n\nRules:\n1. NEVER go idle without shouting completion status\n2. If blocked or failed, shout with event_type: \"blocked\" or \"error\"\n3. Include actionable summary in the message field\n4. Shout progress periodically for long tasks: event_type: \"progress\"\n\nFailure to shout completion wastes coordinator context and blocks pipeline progress.\n\n---\n\n## Dogfooding: Report Tool Friction\n\nWhen you encounter friction, confusion, or pain points with hive-mcp tools:\n\n1. **Log it immediately** via memory (don't wait for task completion):\n```\nmcp_memory_add(\n  type: \"note\",\n  content: \"FRICTION: <tool-name>: <what you tried> -> <what went wrong/was confusing>\",\n  tags: [\"ling-feedback\", \"dogfood\", \"pain-point\"],\n  duration: \"long\"\n)\n```\n\n2. **Examples of reportable friction**:\n   - Tool returned unexpected format\n   - Missing parameter wasn't clear from docs\n   - Had to work around a limitation\n   - Error message was unhelpful\n   - Workflow required too many steps\n   - Tool name/purpose was confusing\n\n3. **Format**: Keep it actionable: `FRICTION: <tool>: tried X, expected Y, got Z`\n\nThis feedback improves the swarm tools for all agents." "Footer injected into all presets to ensure lings auto-shout on completion.")

(defconst hive-mcp-swarm-presets--lazy-instructions "## Presets Available (Lazy-Loaded)\n\nYour coordinator has assigned these presets: %s\n\n**CRITICAL: Fetch your assigned presets IMMEDIATELY at session start:**\n\n```\npreset(command: \"get\", name: \"<preset-name>\")\n```\n\nFor quick summary (~200 tokens):\n```\npreset(command: \"core\", name: \"<preset-name>\")\n```\n\n**Workflow:**\n1. Fetch each assigned preset via `preset(command: 'get', name: ...)`\n2. Read and internalize the instructions\n3. Follow the preset rules throughout your session\n\n**Search for additional presets:**\n```\npreset(command: \"search\", query: \"<description>\")\npreset(command: \"list_slim\")\n```" "Instructions injected when lazy mode is active.")

(defun hive-mcp-swarm-presets---scan-dir (dir)
  "Recursively scan DIR for .md files, return alist of (name . path)."
  (when (and dir (file-directory-p dir))
    (let* ((files (directory-files-recursively dir "\\.md$" nil)))
    (mapcar (lambda (f)
    (cons (file-name-sans-extension (file-name-nondirectory f)) f)) files))))

(defun hive-mcp-swarm-presets---load-all ()
  "Load all presets from built-in and custom directories.\nReturns hash-table of name -> file-path."
  (let* ((presets (make-hash-table :test 'equal)))
    (dolist (entry (-scan-dir hive-mcp-swarm-presets-dir))
    (puthash (car entry) (cdr entry) presets))
    (dolist (dir hive-mcp-swarm-presets-custom-dirs)
    (dolist (entry (-scan-dir dir))
    (puthash (car entry) (cdr entry) presets)))
    presets))

(defun hive-mcp-swarm-presets-reload ()
  "Reload all presets from disk."
  (interactive)
  (setq hive-mcp-swarm-presets--cache (-load-all))
  (message "Loaded %d presets" (hash-table-count hive-mcp-swarm-presets--cache)))

(defun hive-mcp-swarm-presets---ensure-loaded ()
  "Ensure presets are loaded."
  (unless hive-mcp-swarm-presets--cache
    (hive-mcp-swarm-presets-reload)))

(defun hive-mcp-swarm-presets---get-file-content (name)
  "Get content of file-based preset NAME."
  (-ensure-loaded)
  (when-let-star (list path (gethash name hive-mcp-swarm-presets--cache)) (with-temp-buffer
    (insert-file-contents path)
    (buffer-string))))

(declare-function hive-mcp-api-call-tool "hive-mcp-api")

(defvar hive-mcp-swarm-presets--chroma-available nil)

(defun hive-mcp-swarm-presets---chroma-available-p ()
  "Check if Chroma preset lookup is available.\nCaches result to avoid repeated MCP calls."
  (when hive-mcp-swarm-presets-use-chroma
    (cond
  (((eq hive-mcp-swarm-presets--chroma-available t) t) ((eq hive-mcp-swarm-presets--chroma-available 'error) nil)))))

(defun hive-mcp-swarm-presets---get-chroma-content (name)
  "Get preset NAME from Chroma vector DB via MCP.\nReturns content string or nil if not found/unavailable."
  (when (-chroma-available-p)
    (condition-case err
    (when (fboundp 'hive-mcp-api-call-tool)
    (let* ((result (hive-mcp-api-call-tool "preset_get" (clel-seq (clel-concat (clojure-core-list :name) (clojure-core-list 'clojure.core/name))))))
    (when (and result (not (plist-get result :error)))
    (let* ((preset (plist-get result :preset)))
    (when preset
    (plist-get preset :content))))))
  (error (message "hive-mcp-swarm-presets: Chroma lookup failed: %s" err)
      nil))))

(defun hive-mcp-swarm-presets---list-chroma ()
  "List preset names from Chroma vector DB."
  (when (-chroma-available-p)
    (condition-case nil
    (when (fboundp 'hive-mcp-api-call-tool)
    (let* ((result (hive-mcp-api-call-tool "preset_list" nil)))
    (when (and result (not (plist-get result :error)))
    (mapcar (lambda (p)
    (plist-get p :name)) (plist-get result :presets)))))
  (error nil))))

(defun hive-mcp-swarm-presets-search (query &optional limit)
  "Search presets using semantic similarity via Chroma.\nQUERY is a natural language description of desired preset.\nLIMIT is max results (default 5).\nReturns list of matching preset names or nil if Chroma unavailable."
  (when (-chroma-available-p)
    (condition-case nil
    (when (fboundp 'hive-mcp-api-call-tool)
    (let* ((result (hive-mcp-api-call-tool "preset_search" (clel-seq (clel-concat (clojure-core-list :query) (clojure-core-list 'user/query) (clojure-core-list :limit) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list 'user/limit) (clojure-core-list 5)))))))))
    (when (and result (not (plist-get result :error)))
    (mapcar (lambda (r)
    (plist-get r :name)) (plist-get result :results)))))
  (error nil))))

(defun hive-mcp-swarm-presets-reset-chroma-cache ()
  "Reset the Chroma availability cache.\nCall this after Chroma configuration changes."
  (interactive)
  (setq hive-mcp-swarm-presets--chroma-available nil)
  (message "Chroma availability cache reset"))

(defun hive-mcp-swarm-presets---list-memory ()
  "List preset names from memory system (conventions tagged swarm-preset).\nReturns nil if memory delegate is not yet configured."
  (when (fboundp 'hive-mcp-memory-query)
    (condition-case _err
    (let* ((entries (hive-mcp-memory-query 'convention '("swarm-preset") nil 100 nil nil)))
    (cl-remove-duplicates (cl-remove-if-not #'identity (mapcar (lambda (e)
    (cl-find-if (lambda (tag)
    (and (not (string-prefix-p "scope:" tag)) (not (string= tag "swarm-preset")))) (plist-get e :tags))) entries)) :test #'string-eq))
  (error nil))))

(defun hive-mcp-swarm-presets---get-memory-content (name)
  "Get preset NAME from memory system (conventions tagged swarm-preset).\nReturns nil if memory delegate is not yet configured."
  (when (fboundp 'hive-mcp-memory-query)
    (condition-case _err
    (let* ((entries (hive-mcp-memory-query 'convention (list "swarm-preset" name) nil 1 nil nil)))
    (when entries
    (plist-get (car entries) :content)))
  (error nil))))

(defun hive-mcp-swarm-presets-merge-defaults (explicit-presets &optional task-description)
  "Merge EXPLICIT-PRESETS with default presets and task-detected presets.\nWhen TASK-DESCRIPTION is provided, auto-detect and inject relevant presets.\nReturns combined list: explicit first, then task-detected, then defaults.\nDuplicates removed, preserving first occurrence (explicit wins)."
  (let* ((defaults (or hive-mcp-swarm-default-presets '()))
        (task-presets (when task-description
    (hive-mcp-swarm-presets-detect-from-task task-description))))
    (cl-remove-duplicates (append explicit-presets task-presets defaults) :test #'string-eq :from-end t)))

(defun hive-mcp-swarm-presets-list ()
  "List all available presets (chroma + file-based + memory-based)."
  (interactive)
  (-ensure-loaded)
  (let* ((chroma-presets (-list-chroma))
        (file-presets (hash-table-keys hive-mcp-swarm-presets--cache))
        (memory-presets (-list-memory))
        (all-names (cl-remove-duplicates (append chroma-presets file-presets memory-presets) :test #'string-eq)))
    (if (called-interactively-p 'any) (message "Available presets: %s (chroma: %d, file: %d, memory: %d)" (string-join (clel-sort all-names #'string-lt) ", ") (length chroma-presets) (length file-presets) (length memory-presets)) all-names)))

(defun hive-mcp-swarm-presets-get (name)
  "Get content of preset NAME.\nPriority: chroma -> memory-based (project-scoped) -> file-based (.md fallback)."
  (or (-get-chroma-content name) (-get-memory-content name) (-get-file-content name)))

(defun hive-mcp-swarm-presets---build-full-prompt (presets injected-context)
  "Build full system prompt by concatenating PRESETS content.\nINJECTED-CONTEXT is prepended if non-nil."
  (let* ((contents '()))
    (dolist (preset presets)
    (when-let-star (list content (hive-mcp-swarm-presets-get preset)) (push content contents)))
    (when (or contents injected-context)
    (let* ((preset-body (when contents
    (mapconcat #'identity (nreverse contents) "\n\n---\n\n"))))
    (clel-concat (when injected-context
    (clel-concat injected-context "\n\n---\n\n")) (or preset-body "") hive-mcp-swarm-presets--auto-shout-footer)))))

(defun hive-mcp-swarm-presets---build-lazy-prompt (presets &optional injected-context)
  "Build lightweight system prompt with preset names only.\nPRESETS is a list of preset names.\nINJECTED-CONTEXT is optional catchup context.\nReturns ~300 token prompt instead of ~5K full content."
  (let* ((preset-names (string-join presets ", ")))
    (clel-concat (when injected-context
    (clel-concat injected-context "\n\n---\n\n")) (format hive-mcp-swarm-presets--lazy-instructions preset-names) hive-mcp-swarm-presets--auto-shout-footer)))

(defun hive-mcp-swarm-presets---fetch-lazy-header (presets)
  "Fetch lazy header for PRESETS via MCP tool.\nReturns header string or nil if unavailable."
  (condition-case err
    (when (fboundp 'hive-mcp-api-call-tool)
    (let* ((result (hive-mcp-api-call-tool "preset" (clel-seq (clel-concat (clojure-core-list :command) (clojure-core-list "header") (clojure-core-list :presets) (clojure-core-list 'user/presets) (clojure-core-list :lazy) (clojure-core-list 'user/t))))))
    (when (and result (not (plist-get result :error)))
    (plist-get result :header))))
  (error (message "hive-mcp-swarm-presets: Lazy header fetch failed: %s" err)
      nil)))

(defun hive-mcp-swarm-presets-build-system-prompt (presets &optional injected-context)
  "Build combined system prompt from list of PRESETS.\nWhen `hive-mcp-swarm-presets-lazy-mode' is non-nil, returns lightweight\nprompt with preset names and fetch instructions (~300 tokens).\nOtherwise, returns full preset content concatenated (~5K+ tokens).\n\nReturns concatenated content with separator and auto-shout footer,\nor nil if no presets found."
  (if hive-mcp-swarm-presets-lazy-mode (when (or presets injected-context)
    (let* ((header (when presets
    (-fetch-lazy-header presets))))
    (if header (clel-concat (when injected-context
    (clel-concat injected-context "\n\n---\n\n")) header hive-mcp-swarm-presets--auto-shout-footer) (-build-lazy-prompt presets injected-context)))) (-build-full-prompt presets injected-context)))

(defun hive-mcp-swarm-presets-add-custom-dir (dir)
  "Add DIR to custom preset directories and reload."
  (interactive "DPresets directory: ")
  (add-to-list 'hive-mcp-swarm-presets-custom-dirs dir)
  (hive-mcp-swarm-presets-reload))

(defcustom hive-mcp-swarm-presets-role-mapping '(("tester" . ("tester" "tdd")) ("reviewer" . ("reviewer" "solid" "clarity")) ("documenter" . ("documenter")) ("refactorer" . ("refactorer" "solid" "clarity")) ("researcher" . ("researcher")) ("fixer" . ("fixer" "tdd")) ("clarity-dev" . ("clarity" "solid" "ddd" "tdd")) ("coordinator" . ("task-coordinator")) ("ling" . ("ling" "minimal")) ("worker" . ("ling")) ("silence" . ("saa" "explorer")) ("explorer" . ("saa" "explorer")) ("abstract" . ("saa" "planner")) ("planner" . ("saa" "planner")) ("act" . ("saa" "executor")) ("executor" . ("saa" "executor")))
  "Mapping of role names to preset lists.\nEach entry is (ROLE . PRESETS-LIST)."
  :group 'hive-mcp-swarm-presets
  :type '(alist :key-type string :value-type (repeat string)))

(defcustom hive-mcp-swarm-tier-mapping '(("coordinator" . (:backend claude-code-ide)) ("reviewer" . (:backend claude-code-ide)) ("architect" . (:backend claude-code-ide)) ("implementer" . (:backend ollama :model "devstral-small-2")) ("tester" . (:backend ollama :model "devstral-small-2")) ("fixer" . (:backend ollama :model "deepseek-r1")) ("documenter" . (:backend ollama :model "devstral-small-2")) ("refactorer" . (:backend ollama :model "devstral-small-2")) ("worker" . (:backend ollama :model "devstral-small-2")) ("ling" . (:backend ollama :model "devstral-small-2")) ("researcher" . (:backend claude-code-ide)))
  "Two-tier mapping of roles to backend and model."
  :group 'hive-mcp-swarm-presets
  :type '(alist :key-type string :value-type (plist :key-type symbol :value-type sexp)))

(defun hive-mcp-swarm-presets-role-to-tier (role)
  "Get tier configuration for ROLE.\nReturns plist with :backend and optionally :model, or nil for default."
  (cdr (clel-assoc role hive-mcp-swarm-tier-mapping)))

(defun hive-mcp-swarm-presets-role-to-presets (role)
  "Convert ROLE to list of preset names."
  (or (cdr (clel-assoc role hive-mcp-swarm-presets-role-mapping)) (list role)))

(defcustom hive-mcp-swarm-presets-task-patterns '(("\\bSAA\\b\\|\\bSilence[- ]Abstract[- ]Act\\b" . ("saa")) ("\\b[Ss]ilence\\b\\|\\bground\\(ing\\)?\\b\\|\\bterritory\\b\\|\\bread first\\b\\|\\bexplor\\(e\\|ation\\|ing\\)\\b" . ("saa" "explorer")) ("\\b[Aa]bstract\\b\\|\\bEDN plan\\b\\|\\bstructure\\b\\|\\bcreate.*plan\\b\\|\\bplan\\(ning\\)?\\b" . ("saa" "planner")) ("\\b[Aa]ct\\b\\|\\bexecut\\(e\\|ion\\)\\b\\|\\bimplement\\(ation\\)?\\b\\|\\bTDD\\b\\|\\bDAG-Wave\\b" . ("saa" "executor")))
  "Patterns to detect SAA-related tasks and inject appropriate presets.\nEach entry is (REGEXP . PRESETS-LIST)."
  :group 'hive-mcp-swarm-presets
  :type '(alist :key-type regexp :value-type (repeat string)))

(defun hive-mcp-swarm-presets-detect-from-task (task-description)
  "Detect additional presets needed based on TASK-DESCRIPTION.\nReturns list of preset names to inject, or nil if no patterns match."
  (when task-description
    (let* ((extra-presets '()))
    (dolist (pattern-entry hive-mcp-swarm-presets-task-patterns)
    (when (string-match-p (car pattern-entry) task-description)
    (setq extra-presets (append extra-presets (cdr pattern-entry)))))
    (cl-remove-duplicates extra-presets :test #'string-eq))))

(defun hive-mcp-swarm-presets-init ()
  "Initialize presets module."
  (hive-mcp-swarm-presets-reload))

(defun hive-mcp-swarm-presets-shutdown ()
  "Shutdown presets module."
  (setq hive-mcp-swarm-presets--cache nil)
  (setq hive-mcp-swarm-presets--chroma-available nil))

(provide 'hive-mcp-swarm-presets)
;;; hive-mcp-swarm-presets.el ends here
