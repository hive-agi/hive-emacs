;;; hive-mcp-swarm-slaves.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'cl-lib)

(declare-function vterm "vterm")

(declare-function vterm-mode "vterm")

(declare-function vterm-send-string "vterm")

(declare-function vterm-send-return "vterm")

(declare-function eat "eat")

(declare-function eat-mode "eat")

(declare-function eat-exec "eat")

(declare-function eat-term-send-string "eat")

(declare-function claude-code-ide "claude-code-ide")

(declare-function claude-code-ide--create-terminal-session "claude-code-ide")

(declare-function claude-code-ide-mcp-server-ensure-server "claude-code-ide-mcp-server")

(declare-function hive-mcp-ellama-swarm-spawn "hive-mcp-ellama")

(declare-function hive-mcp-ellama-swarm-dispatch "hive-mcp-ellama")

(declare-function hive-mcp-swarm-terminal-send "hive-mcp-swarm-terminal")

(declare-function hive-mcp-swarm-presets-build-system-prompt "hive-mcp-swarm-presets")

(declare-function hive-mcp-swarm-presets-role-to-presets "hive-mcp-swarm-presets")

(declare-function hive-mcp-swarm-presets-role-to-tier "hive-mcp-swarm-presets")

(declare-function hive-mcp-swarm-presets-merge-defaults "hive-mcp-swarm-presets")

(declare-function hive-mcp-swarm-prompts-clear-slave "hive-mcp-swarm-prompts")

(declare-function hive-mcp-swarm-events-emit-slave-spawned "hive-mcp-swarm-events")

(declare-function hive-mcp-swarm-events-emit-slave-killed "hive-mcp-swarm-events")

(defvar hive-mcp-swarm--slaves nil)

(defvar hive-mcp-swarm--task-counter nil)

(defvar hive-mcp-swarm--session-id nil)

(defvar hive-mcp-swarm--current-depth nil)

(defvar hive-mcp-swarm--ancestry nil)

(defvar hive-mcp-swarm-max-slaves nil)

(defvar hive-mcp-swarm-max-depth nil)

(defvar hive-mcp-swarm-rate-limit-window nil)

(defvar hive-mcp-swarm-rate-limit-max-spawns nil)

(defvar hive-mcp-swarm-terminal nil)

(defvar hive-mcp-swarm-buffer-prefix nil)

(defvar hive-mcp-swarm-claude-command nil)

(defvar hive-mcp-swarm-prompt-mode nil)

(declare-function hive-mcp-swarm-list-presets "hive-mcp-swarm")

(defvar hive-mcp-swarm-slaves--spawn-timestamps nil)

(defun hive-mcp-swarm-slaves-generate-id (name)
  "Generate unique slave ID for NAME."
  (format "swarm-%s-%d" name (floor (float-time))))

(defun hive-mcp-swarm-slaves-generate-task-id (slave-id)
  "Generate unique task ID for SLAVE-ID."
  (cl-incf hive-mcp-swarm--task-counter)
  (format "task-%s-%03d" (replace-regexp-in-string "^swarm-" "" slave-id) hive-mcp-swarm--task-counter))

(defun hive-mcp-swarm-slaves---depth-label (depth)
  "Return human-readable label for DEPTH level."
  (pcase depth
  (0 "master")
  (1 "child")
  (2 "grandchild")
  (3 "great-grandchild")
  ('_ (format "depth-%d" depth))))

(defun hive-mcp-swarm-slaves-check-depth ()
  "Check if we can spawn at current depth.\nReturns the current depth if allowed, signals error if blocked."
  (let* ((depth (string-to-number (or (getenv "CLAUDE_SWARM_DEPTH") "0")))
        (master-id (getenv "CLAUDE_SWARM_MASTER"))
        (my-id (getenv "CLAUDE_SWARM_SLAVE_ID")))
    (setq hive-mcp-swarm--current-depth depth)
    (when (and my-id master-id)
    (push (cons my-id master-id) hive-mcp-swarm--ancestry))
    (when (>= depth hive-mcp-swarm-max-depth)
    (error "Recursion limit reached: %s (depth %d) cannot spawn children.\nMaximum depth is %d (master -> child -> grandchild -> great-grandchild).\nThis limit prevents runaway recursive spawning." (-depth-label depth) depth hive-mcp-swarm-max-depth))
    depth))

(defun hive-mcp-swarm-slaves-check-rate-limit ()
  "Check if spawn rate limit allows a new spawn.\nRemoves old timestamps and checks count within window."
  (let* ((now (float-time))
        (window-start (- now hive-mcp-swarm-rate-limit-window)))
    (setq hive-mcp-swarm-slaves--spawn-timestamps (cl-remove-if (lambda (ts)
    (< ts window-start)) hive-mcp-swarm-slaves--spawn-timestamps))
    (when (>= (length hive-mcp-swarm-slaves--spawn-timestamps) hive-mcp-swarm-rate-limit-max-spawns)
    (error "Rate limit exceeded: %d spawns in %d seconds.\nWait before spawning more slaves to prevent spawn storms." hive-mcp-swarm-rate-limit-max-spawns hive-mcp-swarm-rate-limit-window))
    (push now hive-mcp-swarm-slaves--spawn-timestamps)))

(defun hive-mcp-swarm-slaves-check-limit ()
  "Check if we can spawn more slaves."
  (when (>= (hash-table-count hive-mcp-swarm--slaves) hive-mcp-swarm-max-slaves)
    (error "Maximum slave count (%d) reached.\nKill some slaves with `hive-mcp-swarm-kill' before spawning more." hive-mcp-swarm-max-slaves)))

(defun hive-mcp-swarm-slaves---project-root ()
  "Get current project root."
  (or (when (fboundp 'project-root)
    (when-let-star (list proj (project-current)) (project-root proj))) default-directory))

(provide 'hive-mcp-swarm-slaves)
;;; hive-mcp-swarm-slaves.el ends here
