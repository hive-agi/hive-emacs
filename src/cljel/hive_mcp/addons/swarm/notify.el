;;; hive-mcp-swarm-notify.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'cl-lib)

(defgroup hive-mcp-swarm-notify nil
  "Notification settings for swarm."
  :group 'hive-mcp-swarm
  :prefix "hive-mcp-swarm-notify-")

(defcustom hive-mcp-swarm-notify-enabled t
  "If non-nil, send desktop notifications for swarm events."
  :group 'hive-mcp-swarm-notify
  :type 'boolean)

(defcustom hive-mcp-swarm-notify-timeout 10000
  "Notification timeout in milliseconds (10 seconds default)."
  :group 'hive-mcp-swarm-notify
  :type 'integer)

(defcustom hive-mcp-swarm-notify-sound t
  "If non-nil, play alert sound with urgent notifications."
  :group 'hive-mcp-swarm-notify
  :type 'boolean)

(defcustom hive-mcp-swarm-notify-log-buffer "*Swarm Notifications*"
  "Buffer name for notification log."
  :group 'hive-mcp-swarm-notify
  :type 'string)

(defcustom hive-mcp-swarm-notify-urgency-mapping '((critical . "critical") (high . "critical") (normal . "normal") (low . "low"))
  "Mapping from urgency symbols to notify-send urgency strings."
  :group 'hive-mcp-swarm-notify
  :type '(alist :key-type symbol :value-type string))

(defvar hive-mcp-swarm-notify--stats '(:sent 0 :failed 0 :fallback 0)
  "Notification statistics for debugging.")

(defvar hive-mcp-swarm-notify--last-notification nil)

(defvar hive-mcp-swarm-notify--dedup-window 2.0
  "Seconds to deduplicate identical notifications.")

(defun hive-mcp-swarm-notify---log (level message &rest args)
  "Log MESSAGE with LEVEL to notification buffer.\nLEVEL is a symbol like `info', `warn', `error'."
  (let* ((formatted (apply #'format message args))
        (timestamp (format-time-string "%H:%M:%S")))
    (with-current-buffer (get-buffer-create hive-mcp-swarm-notify-log-buffer)
    (goto-char (point-max))
    (insert (format "[%s] %s: %s\n" timestamp (upcase (symbol-name level)) formatted)))))

(defun hive-mcp-swarm-notify---should-send-p (title message)
  "Return t if notification should be sent (not a duplicate)."
  (let* ((key (format "%s|%s" title message))
        (now (float-time))
        (last hive-mcp-swarm-notify--last-notification)
        (last-key (car last))
        (last-time (cdr last)))
    (if (and last-key last-time (string= key last-key) (< (- now last-time) hive-mcp-swarm-notify--dedup-window)) (progn
  (-log 'info "Deduplicated: %s" title)
  nil) (setq hive-mcp-swarm-notify--last-notification (cons key now)))))

(defun hive-mcp-swarm-notify---try-notify-send (title message urgency)
  "Try to send notification via notify-send.\nReturns t on success, nil on failure."
  (condition-case err
    (let* ((urgency-str (or (alist-get urgency hive-mcp-swarm-notify-urgency-mapping) "normal"))
        (timeout-str (number-to-string hive-mcp-swarm-notify-timeout)))
    (if (executable-find "notify-send") (progn
  (start-process "hive-notify" nil "notify-send" "-u" urgency-str "-t" timeout-str "-a" "Hive-MCP Swarm" "-i" "dialog-information" title message)
  (-log 'info "notify-send: %s - %s" title message)
  t) (-log 'warn "notify-send not found in PATH")))
  (error (-log 'error "notify-send failed: %s" (error-message-string err))
      nil)))

(defun hive-mcp-swarm-notify---try-dbus (title message urgency)
  "Try to send notification via D-Bus (notifications-notify).\nReturns t on success, nil on failure."
  (condition-case err
    (if (fboundp 'notifications-notify) (progn
  (notifications-notify :title title :body message :urgency urgency :timeout hive-mcp-swarm-notify-timeout :app-name "Hive-MCP Swarm")
  (-log 'info "D-Bus notify: %s - %s" title message)
  t) (-log 'warn "notifications-notify not available"))
  (error (-log 'error "D-Bus notify failed: %s" (error-message-string err))
      nil)))

(defun hive-mcp-swarm-notify---fallback (title message urgency)
  "Fallback notification via message and optional ding.\nAlways succeeds."
  (message "HIVE ALERT [%s]: %s - %s" (upcase (symbol-name urgency)) title message)
  (when (and hive-mcp-swarm-notify-sound (memq urgency '(critical high)))
    (ding t))
  (-log 'info "Fallback notify: %s - %s" title message)
  t)

(defun hive-mcp-swarm-notify-notify (title message &optional urgency)
  "Send notification with TITLE and MESSAGE.\nURGENCY is a symbol: `critical', `high', `normal', or `low' (default: normal).\n\nGuarantees notification delivery through multiple fallback layers:\n1. notify-send (CLI tool)\n2. D-Bus notifications\n3. Emacs message + ding\n\nReturns t if notification was sent, nil if disabled or deduplicated."
  (unless hive-mcp-swarm-notify-enabled
    (-log 'info "Notifications disabled, skipping: %s" title)
    (cl-return-from hive-mcp-swarm-notify-notify nil))
  (let* ((urgency (or urgency 'normal)))
    (unless (-should-send-p title message)
    (cl-return-from hive-mcp-swarm-notify-notify nil))
    (let* ((sent nil))
    (setq sent (-try-notify-send title message urgency))
    (unless sent
    (setq sent (-try-dbus title message urgency))
    (when sent
    (cl-incf (plist-get hive-mcp-swarm-notify--stats :fallback))))
    (unless sent
    (-fallback title message urgency)
    (cl-incf (plist-get hive-mcp-swarm-notify--stats :fallback))
    (setq sent t))
    (if sent (cl-incf (plist-get hive-mcp-swarm-notify--stats :sent)) (cl-incf (plist-get hive-mcp-swarm-notify--stats :failed)))
    sent)))

(defun hive-mcp-swarm-notify-notify-prompt (slave-id prompt-text)
  "Notify about permission PROMPT-TEXT from SLAVE-ID."
  (hive-mcp-swarm-notify-notify (format "Swarm Prompt: %s" slave-id) (truncate-string-to-width prompt-text 100) 'critical))

(defun hive-mcp-swarm-notify-notify-ask (agent-id question)
  "Notify about hivemind QUESTION from AGENT-ID."
  (hive-mcp-swarm-notify-notify (format "NEEDS INPUT: %s" agent-id) (truncate-string-to-width question 100) 'critical))

(defun hive-mcp-swarm-notify-notify-idle (slave-id idle-secs)
  "Notify about SLAVE-ID being idle for IDLE-SECS seconds."
  (hive-mcp-swarm-notify-notify (format "Ling Idle: %s" slave-id) (format "No activity for %.0f seconds" idle-secs) 'high))

(defun hive-mcp-swarm-notify-notify-error (slave-id error-type error-preview)
  "Notify about ERROR-TYPE from SLAVE-ID with ERROR-PREVIEW."
  (hive-mcp-swarm-notify-notify (format "Ling Error: %s" slave-id) (format "[%s] %s" error-type (truncate-string-to-width (or error-preview "") 80)) 'critical))

(defun hive-mcp-swarm-notify-notify-completed (slave-id &optional duration-secs)
  "Notify about SLAVE-ID completing task with optional DURATION-SECS."
  (hive-mcp-swarm-notify-notify (format "Task Completed: %s" slave-id) (if duration-secs (format "Finished in %.1f seconds" duration-secs) "Task finished successfully") 'normal))

(defun hive-mcp-swarm-notify-notify-blocked (slave-id reason)
  "Notify about SLAVE-ID being blocked for REASON."
  (hive-mcp-swarm-notify-notify (format "Ling Blocked: %s" slave-id) (truncate-string-to-width (or reason "Unknown reason") 100) 'high))

(defun hive-mcp-swarm-notify-notify-prompt-stall (slave-id idle-secs prompt-text)
  "Notify about SLAVE-ID stalled on unanswered prompt for IDLE-SECS.\nPROMPT-TEXT is the pending prompt."
  (hive-mcp-swarm-notify-notify (format "URGENT: %s Waiting!" slave-id) (format "Stalled %.0fs on: %s" idle-secs (truncate-string-to-width (or prompt-text "") 60)) 'critical))

(defun hive-mcp-swarm-notify-stats ()
  "Return notification statistics."
  hive-mcp-swarm-notify--stats)

(defun hive-mcp-swarm-notify-show-log ()
  "Display the notification log buffer."
  (interactive)
  (display-buffer (get-buffer-create hive-mcp-swarm-notify-log-buffer)))

(defun hive-mcp-swarm-notify-test ()
  "Send a test notification to verify the system works."
  (interactive)
  (hive-mcp-swarm-notify-notify "Hive-MCP Test" "If you see this, notifications are working!" 'normal)
  (message "Test notification sent. Check desktop and *Swarm Notifications* buffer."))

(defun hive-mcp-swarm-notify-init ()
  "Initialize notification module."
  (setq hive-mcp-swarm-notify--stats '(:sent 0 :failed 0 :fallback 0))
  (setq hive-mcp-swarm-notify--last-notification nil)
  (-log 'info "Notification module initialized")
  (unless (executable-find "notify-send")
    (-log 'warn "notify-send not found - install libnotify-bin for best results")))

(defun hive-mcp-swarm-notify-shutdown ()
  "Shutdown notification module."
  (-log 'info "Notification module shutdown. Stats: sent=%d failed=%d fallback=%d" (plist-get hive-mcp-swarm-notify--stats :sent) (plist-get hive-mcp-swarm-notify--stats :failed) (plist-get hive-mcp-swarm-notify--stats :fallback)))

(provide 'hive-mcp-swarm-notify)
;;; hive-mcp-swarm-notify.el ends here
