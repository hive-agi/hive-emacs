;;; hive-mcp-channel-ws.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'websocket)

(require 'json)

(defgroup hive-mcp-channel-ws nil
  "WebSocket channel settings for hive-mcp."
  :group 'hive-mcp
  :prefix "hive-mcp-channel-ws-")

(defcustom hive-mcp-channel-ws-url "ws://localhost:9999"
  "WebSocket server URL."
  :group 'hive-mcp-channel-ws
  :type 'string)

(defcustom hive-mcp-channel-ws-reconnect-interval 5.0
  "Base seconds between reconnection attempts."
  :group 'hive-mcp-channel-ws
  :type 'number)

(defcustom hive-mcp-channel-ws-max-reconnect-interval 120.0
  "Maximum seconds between reconnection attempts."
  :group 'hive-mcp-channel-ws
  :type 'number)

(defcustom hive-mcp-channel-ws-max-reconnects 10
  "Maximum reconnection attempts (0 = unlimited)."
  :group 'hive-mcp-channel-ws
  :type 'integer)

(defcustom hive-mcp-channel-ws-auto-connect t
  "Whether to auto-connect at Emacs startup."
  :group 'hive-mcp-channel-ws
  :type 'boolean)

(defcustom hive-mcp-channel-ws-startup-delay 3.0
  "Seconds to wait after Emacs startup before connecting."
  :group 'hive-mcp-channel-ws
  :type 'number)

(defcustom hive-mcp-channel-ws-keepalive-interval 25.0
  "Seconds between keepalive pings (0 to disable)."
  :group 'hive-mcp-channel-ws
  :type 'number)

(defvar hive-mcp-channel-ws--connection nil)

(defvar hive-mcp-channel-ws--handlers (make-hash-table :test 'equal)
  "Event handlers indexed by event type string.")

(defvar hive-mcp-channel-ws--reconnect-timer nil)

(defvar hive-mcp-channel-ws--reconnect-count 0
  "Current reconnection attempt count.")

(defvar hive-mcp-channel-ws--degraded-mode nil)

(defvar hive-mcp-channel-ws--message-queue nil)

(defvar hive-mcp-channel-ws--keepalive-timer nil)

(defun hive-mcp-channel-ws--start-keepalive ()
  "Start the keepalive timer."
  (hive-mcp-channel-ws--stop-keepalive)
  (when (> hive-mcp-channel-ws-keepalive-interval 0)
    (setq hive-mcp-channel-ws--keepalive-timer (run-with-timer hive-mcp-channel-ws-keepalive-interval hive-mcp-channel-ws-keepalive-interval #'hive-mcp-channel-ws--send-keepalive))))

(defun hive-mcp-channel-ws--stop-keepalive ()
  "Stop the keepalive timer."
  (when hive-mcp-channel-ws--keepalive-timer
    (cancel-timer hive-mcp-channel-ws--keepalive-timer)
    (setq hive-mcp-channel-ws--keepalive-timer nil)))

(defun hive-mcp-channel-ws--send-keepalive ()
  "Send a keepalive ping if connected.\nGuards against stale connections with condition-case."
  (when (hive-mcp-channel-ws-connected-p)
    (condition-case nil
    (websocket-send-text hive-mcp-channel-ws--connection "ping")
  (error nil))))

(defun hive-mcp-channel-ws--dispatch (msg)
  "Dispatch parsed JSON MSG to registered handlers.\nEach handler is called within condition-case for thread safety."
  (let* ((type (cdr (clel-assoc 'type msg)))
        (handlers (gethash type hive-mcp-channel-ws--handlers)))
    (dolist (handler handlers)
    (condition-case err
    (funcall handler msg)
  (error (message "hive-mcp-channel-ws: Handler error for %s: %s" type (error-message-string err)))))))

(defun hive-mcp-channel-ws--on-message (_ws frame)
  "Handle incoming WebSocket FRAME.\nRuns async in WebSocket callback context - all operations guarded."
  (condition-case err
    (let* ((text (websocket-frame-text frame)))
    (cond
  (((string= text "pong") nil) ((string= text "ping") (when (hive-mcp-channel-ws-connected-p)
    (condition-case nil
    (websocket-send-text hive-mcp-channel-ws--connection "pong")
  (error nil)))))))
  (error (message "hive-mcp-channel-ws: on-message error: %s" (error-message-string err)))))

(defun hive-mcp-channel-ws--on-open (_ws)
  "Handle WebSocket connection opened.\nRuns async - state mutations are atomic (single setq)."
  (condition-case err
    (progn
  (message "hive-mcp-channel-ws: Connected to %s" hive-mcp-channel-ws-url)
  (setq hive-mcp-channel-ws--reconnect-count 0 hive-mcp-channel-ws--degraded-mode nil)
  (hive-mcp-channel-ws--start-keepalive)
  (while hive-mcp-channel-ws--message-queue
    (hive-mcp-channel-ws-send (clel-pop hive-mcp-channel-ws--message-queue))))
  (error (message "hive-mcp-channel-ws: on-open ERROR: %s" (error-message-string err)))))

(defun hive-mcp-channel-ws--on-close (_ws)
  "Handle WebSocket connection closed.\nRuns async - cleanup timers and schedule reconnect."
  (condition-case err
    (progn
  (hive-mcp-channel-ws--stop-keepalive)
  (setq hive-mcp-channel-ws--connection nil)
  (cond
  ((hive-mcp-channel-ws--degraded-mode nil) ((and (> hive-mcp-channel-ws-max-reconnects 0) (>= hive-mcp-channel-ws--reconnect-count hive-mcp-channel-ws-max-reconnects)) (setq hive-mcp-channel-ws--degraded-mode t) (message "hive-mcp-channel-ws: Graceful degradation (server unavailable)")))))
  (error (message "hive-mcp-channel-ws: on-close ERROR: %s" (error-message-string err)))))

(defun hive-mcp-channel-ws--on-error (_ws _type err)
  "Handle WebSocket error ERR."
  (message "hive-mcp-channel-ws: Error: %s" err))

(defun hive-mcp-channel-ws--calculate-backoff ()
  "Calculate reconnect interval with exponential backoff.\nReturns base * 2^(attempt-1), capped at max-reconnect-interval."
  (let* ((interval (* hive-mcp-channel-ws-reconnect-interval (expt 2 (cl-max 0 (1- hive-mcp-channel-ws--reconnect-count))))))
    (cl-min interval hive-mcp-channel-ws-max-reconnect-interval)))

(defun hive-mcp-channel-ws--schedule-reconnect ()
  "Schedule a reconnection attempt with exponential backoff."
  (hive-mcp-channel-ws--cancel-reconnect)
  (cl-incf hive-mcp-channel-ws--reconnect-count)
  (let* ((interval (hive-mcp-channel-ws--calculate-backoff)))
    (message "hive-mcp-channel-ws: Reconnecting in %.1fs (attempt %d/%s)" interval hive-mcp-channel-ws--reconnect-count (if (equal 0 hive-mcp-channel-ws-max-reconnects) "unlimited" (number-to-string hive-mcp-channel-ws-max-reconnects)))
    (setq hive-mcp-channel-ws--reconnect-timer (run-with-timer interval nil #'hive-mcp-channel-ws-connect))))

(defun hive-mcp-channel-ws--cancel-reconnect ()
  "Cancel pending reconnection timer."
  (when hive-mcp-channel-ws--reconnect-timer
    (cancel-timer hive-mcp-channel-ws--reconnect-timer)
    (setq hive-mcp-channel-ws--reconnect-timer nil)))

(defun hive-mcp-channel-ws-connect ()
  "Connect to the WebSocket channel server.\nCancels any pending reconnection timer first.\nCloses existing connection before reconnecting."
  (interactive)
  (hive-mcp-channel-ws--cancel-reconnect)
  (when (and hive-mcp-channel-ws--connection (websocket-openp hive-mcp-channel-ws--connection))
    (condition-case nil
    (websocket-close hive-mcp-channel-ws--connection)
  (error nil)))
  (condition-case err
    (setq hive-mcp-channel-ws--connection (websocket-open hive-mcp-channel-ws-url :on-message #'hive-mcp-channel-ws--on-message :on-open #'hive-mcp-channel-ws--on-open :on-close #'hive-mcp-channel-ws--on-close :on-error #'hive-mcp-channel-ws--on-error))
  (error (message "hive-mcp-channel-ws: Connect failed: %s" (error-message-string err))
      (when (or (equal 0 hive-mcp-channel-ws-max-reconnects) (< hive-mcp-channel-ws--reconnect-count hive-mcp-channel-ws-max-reconnects))
    (hive-mcp-channel-ws--schedule-reconnect)))))

(defun hive-mcp-channel-ws-disconnect ()
  "Disconnect from the WebSocket channel server.\nCleans up keepalive timer and reconnection timer."
  (interactive)
  (hive-mcp-channel-ws--cancel-reconnect)
  (hive-mcp-channel-ws--stop-keepalive)
  (when hive-mcp-channel-ws--connection
    (condition-case nil
    (websocket-close hive-mcp-channel-ws--connection)
  (error nil))
    (setq hive-mcp-channel-ws--connection nil))
  (message "hive-mcp-channel-ws: Disconnected"))

(defun hive-mcp-channel-ws-connected-p ()
  "Return t if WebSocket is connected."
  (and hive-mcp-channel-ws--connection (websocket-openp hive-mcp-channel-ws--connection)))

(defun hive-mcp-channel-ws-send (msg)
  "Send MSG through the WebSocket channel.\nMSG should be a plist or alist that will be JSON-encoded.\nIf not connected, queues the message for later sending.\nGuards send with process-live check via websocket-openp."
  (if (hive-mcp-channel-ws-connected-p) (condition-case err
    (let* ((json-str (json-encode msg)))
    (websocket-send-text hive-mcp-channel-ws--connection json-str)
    t)
  (error (message "hive-mcp-channel-ws: Send error: %s" (error-message-string err))
      (push msg hive-mcp-channel-ws--message-queue)
      nil)) (push msg hive-mcp-channel-ws--message-queue)))

(defun hive-mcp-channel-ws-on (event-type handler)
  "Register HANDLER for EVENT-TYPE.\nEVENT-TYPE can be a string like \"hivemind-progress\", a keyword\nlike :hivemind-progress, or a symbol.\nHANDLER receives the parsed JSON message as an alist."
  (let* ((type-str (if (keywordp event-type) (substring (symbol-name event-type) 1) (if (symbolp event-type) (symbol-name event-type) event-type))))
    (let* ((handlers (gethash type-str hive-mcp-channel-ws--handlers)))
    (puthash type-str (cons handler handlers) hive-mcp-channel-ws--handlers))))

(defun hive-mcp-channel-ws-off (event-type &optional handler)
  "Unregister HANDLER from EVENT-TYPE.\nIf HANDLER is nil, remove all handlers for EVENT-TYPE."
  (let* ((type-str (if (keywordp event-type) (substring (symbol-name event-type) 1) event-type)))
    (if handler (let* ((handlers (gethash type-str hive-mcp-channel-ws--handlers)))
    (puthash type-str (delete handler handlers) hive-mcp-channel-ws--handlers)) (remhash type-str hive-mcp-channel-ws--handlers))))

(defun hive-mcp-channel-ws-status ()
  "Return status of the WebSocket channel."
  (interactive)
  (let* ((status (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/connected) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/hive-mcp-channel-ws-connected-p))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/degraded) (clojure-core-list '.) (clojure-core-list 'user/hive-mcp-channel-ws--degraded-mode)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/reconnect-count) (clojure-core-list '.) (clojure-core-list 'user/hive-mcp-channel-ws--reconnect-count)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/queued) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/length) (clojure-core-list 'user/hive-mcp-channel-ws--message-queue))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'user/url) (clojure-core-list '.) (clojure-core-list 'user/hive-mcp-channel-ws-url))))))))
    (when (called-interactively-p 'any)
    (message "hive-mcp-channel-ws: %s" (if (hive-mcp-channel-ws-connected-p) "Connected" (if hive-mcp-channel-ws--degraded-mode "Degraded" "Disconnected"))))
    status))

(defun hive-mcp-channel-ws--startup-connect ()
  "Attempt connection at startup (non-blocking, graceful failure)."
  (condition-case err
    (when hive-mcp-channel-ws-auto-connect
    (setq hive-mcp-channel-ws--degraded-mode nil hive-mcp-channel-ws--reconnect-count 0)
    (hive-mcp-channel-ws-connect))
  (error (message "hive-mcp-channel-ws: Startup connect error: %s" (error-message-string err)))))

(defun hive-mcp-channel-ws-setup ()
  "Set up WebSocket channel auto-connection at startup."
  (when hive-mcp-channel-ws-auto-connect
    (run-with-timer hive-mcp-channel-ws-startup-delay nil #'hive-mcp-channel-ws--startup-connect)))

(if after-init-time (hive-mcp-channel-ws-setup) (add-hook 'emacs-startup-hook #'hive-mcp-channel-ws-setup))

(provide 'hive-mcp-channel-ws)

(provide 'hive-mcp-channel-ws)
;;; hive-mcp-channel-ws.el ends here
