;;; claude-code-ide.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'cl-lib)
(require 'project)
(require 'claude-code-ide-debug)
(require 'claude-code-ide-mcp)
(require 'claude-code-ide-transient)
(require 'claude-code-ide-mcp-server)
(require 'claude-code-ide-emacs-tools)

;;; Code:



(defvar eat-terminal)

(defvar eat--synchronize-scroll-function)

(defvar vterm-shell)

(defvar vterm-environment)

(defvar eat-term-name)

(defvar vterm--process)

(declare-function vterm "vterm" (&optional arg))

(declare-function vterm-send-string "vterm" (string))

(declare-function vterm-send-escape "vterm" (nil))

(declare-function vterm-send-return "vterm" (nil))

(declare-function vterm--window-adjust-process-window-size "vterm" (&optional frame))

(declare-function eat-mode "eat" (nil))

(declare-function eat-exec "eat" (buffer symbol-name command startfile &rest switches))

(declare-function eat-term-send-string "eat" (terminal string))

(declare-function eat-term-display-cursor "eat" (terminal))

(declare-function eat--adjust-process-window-size "eat" (process windows))

(defgroup claude-code-ide nil
  "Claude Code integration for Emacs."
  :group 'tools
  :prefix "claude-code-ide-")

(defcustom claude-code-ide-cli-path "claude"
  "Path to the Claude Code CLI executable."
  :group 'claude-code-ide
  :type 'string)

(defcustom claude-code-ide-buffer-name-function (var claude-code-ide--default-buffer-name)
  "Function to generate buffer names for Claude Code sessions.\nThe function is called with one argument, the working directory,\nand should return a string to use as the buffer name."
  :group 'claude-code-ide
  :type 'function)

(defcustom claude-code-ide-cli-debug nil
  "When non-nil, launch Claude Code with the -d debug flag."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-cli-extra-flags ""
  "Additional flags to pass to the Claude Code CLI.\nThis should be a string of space-separated flags, e.g. \"--model opus\"."
  :group 'claude-code-ide
  :type 'string)

(defcustom claude-code-ide-system-prompt nil
  "System prompt to append to Claude's default system prompt.\nWhen non-nil, the --append-system-prompt flag will be added with this value.\nSet to nil to disable (default)."
  :group 'claude-code-ide
  :type '(choice (const :tag "Disabled" nil) (string :tag "System prompt text")))

(defcustom claude-code-ide-mcp-allowed-tools 'auto
  "Configuration for allowed MCP tools when MCP server is enabled.\nCan be one of:\n  'auto - Automatically allow all configured emacs-tools (default)\n  nil - Disable the --allowedTools flag\n  A string - Custom pattern/tools passed directly to --allowedTools\n  A list of strings - List of specific tool names to allow"
  :group 'claude-code-ide
  :type '(choice (const :tag "Auto (all emacs-tools)" auto) (const :tag "Disabled" nil) (string :tag "Custom pattern") (repeat :tag "Specific tools" string)))

(defcustom claude-code-ide-window-side 'right
  "Side of the frame where the Claude Code window should appear.\nCan be `'left', `'right', `'top', or `'bottom'."
  :group 'claude-code-ide
  :type '(choice (const :tag "Left" left) (const :tag "Right" right) (const :tag "Top" top) (const :tag "Bottom" bottom)))

(defcustom claude-code-ide-window-width 90
  "Width of the Claude Code side window when opened on left or right."
  :group 'claude-code-ide
  :type 'integer)

(defcustom claude-code-ide-window-height 20
  "Height of the Claude Code side window when opened on top or bottom."
  :group 'claude-code-ide
  :type 'integer)

(defcustom claude-code-ide-focus-on-open t
  "Whether to focus the Claude Code window when it opens."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-focus-claude-after-ediff t
  "Whether to focus the Claude Code window after opening ediff.\nWhen non-nil (default), focus returns to the Claude Code window\nafter opening ediff."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-show-claude-window-in-ediff t
  "Whether to show the Claude Code side window when viewing diffs.\nWhen non-nil (default), the Claude Code side window is restored\nafter opening ediff."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-use-ide-diff t
  "Whether to use IDE diff viewer for file differences.\nWhen non-nil (default), Claude Code will open an IDE diff viewer\n(ediff) when showing file changes."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-switch-tab-on-ediff t
  "Whether to switch back to Claude's original tab when opening ediff."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-use-side-window t
  "Whether to display Claude Code in a side window."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-terminal-backend 'vterm
  "Terminal backend to use for Claude Code sessions.\nCan be either `vterm' or `eat'."
  :group 'claude-code-ide
  :type '(choice (const :tag "vterm" vterm) (const :tag "eat" eat)))

(defcustom claude-code-ide-prevent-reflow-glitch t
  "Workaround for Claude Code terminal scrolling bug #1422.\nWhen non-nil (default), prevents the terminal from reflowing on height-only\nchanges which can trigger uncontrollable scrolling in Claude Code."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-vterm-anti-flicker t
  "Enable intelligent flicker reduction for vterm display.\nWhen enabled, this feature optimizes terminal rendering by detecting\nand batching rapid update sequences."
  :group 'claude-code-ide
  :type 'boolean)

(defcustom claude-code-ide-vterm-render-delay 0.005
  "Rendering optimization delay for batched terminal updates.\nThe 0.005 second (5ms) default delivers optimal rendering quality\nwith imperceptible latency."
  :group 'claude-code-ide
  :type 'number)

(defcustom claude-code-ide-terminal-initialization-delay 0.1
  "Initialization delay for terminal stability.\nProvides a brief stabilization period when launching terminals\nto ensure proper layout calculation and rendering."
  :group 'claude-code-ide
  :type 'number)

(defcustom claude-code-ide-eat-preserve-position t
  "Maintain terminal scroll position when switching windows."
  :group 'claude-code-ide
  :type 'boolean)

(define-obsolete-variable-alias 'claude-code-ide-eat-initialization-delay 'claude-code-ide-terminal-initialization-delay "0.2.6")

(defconst claude-code-ide--active-editor-notification-delay 0.1 "Delay in seconds before sending active editor notification after connection.")

(defvar claude-code-ide--cli-available nil
  "Whether Claude Code CLI is available and detected.")

(defvar claude-code-ide--processes (make-hash-table :test 'equal)
  "Hash table mapping project/directory roots to their Claude Code processes.")

(defvar claude-code-ide--session-ids (make-hash-table :test 'equal)
  "Hash table mapping project/directory roots to their session IDs.")

(defvar claude-code-ide--last-accessed-buffer nil
  "The most recently accessed Claude Code buffer.")

(defvar-local claude-code-ide--vterm-render-queue nil "List of pending terminal output strings awaiting batched rendering.")

(defvar-local claude-code-ide--vterm-render-timer nil "Timer for executing queued rendering operations.")

(defun claude-code-ide---count-escape-sequence (sequence input)
  "Count occurrences of escape SEQUENCE in INPUT."
  (let* ((count 0)
        (start 0))
    (while (setq start (string-search sequence input start))
    (cl-incf count)
    (cl-incf start (length sequence)))
    count))

(provide 'claude-code-ide)
;;; claude-code-ide.el ends here
