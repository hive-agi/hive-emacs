;;; claude-code-ide-diagnostics.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'cl-lib)
(require 'json)
(require 'claude-code-ide-debug)

;;; Code:



(require 'flycheck nil t)

(require 'flymake nil t)

(declare-function claude-code-ide-mcp-session-project-dir "claude-code-ide-mcp" (session))

(defvar flycheck-current-errors nil)

(declare-function flycheck-error-line "flycheck" (err))

(declare-function flycheck-error-column "flycheck" (err))

(declare-function flycheck-error-end-line "flycheck" (err))

(declare-function flycheck-error-end-column "flycheck" (err))

(declare-function flycheck-error-level "flycheck" (err))

(declare-function flycheck-error-checker "flycheck" (err))

(declare-function flycheck-error-message "flycheck" (err))

(defcustom claude-code-ide-diagnostics-backend 'auto
  "Backend to use for diagnostics collection.\nCan be one of:\n- `auto': Automatically detect available backend (flycheck or flymake)\n- `flycheck': Use flycheck for diagnostics\n- `flymake': Use flymake for diagnostics"
  :group 'claude-code-ide
  :type '(choice (const :tag "Automatic detection" auto) (const :tag "Flycheck" flycheck) (const :tag "Flymake" flymake)))

(defun claude-code-ide-diagnostics---severity-to-vscode (severity)
  "Convert diagnostic SEVERITY to VS Code format.\nReturns: 1 (Error), 2 (Warning), 3 (Information), 4 (Hint)."
  (pcase severity
  ((quote error) 1)
  ((quote warning) 2)
  ((quote info) 3)
  ((quote hint) 4)
  ((quote flymake-error) 1)
  ((quote :error) 1)
  ((quote flymake-warning) 2)
  ((quote :warning) 2)
  ((quote flymake-note) 3)
  ((quote :note) 3)
  ('_ 3)))

(defun claude-code-ide-diagnostics---severity-to-string (severity)
  "Convert diagnostic SEVERITY to VS Code string format."
  (pcase severity
  ((quote error) "Error")
  ((quote warning) "Warning")
  ((quote info) "Information")
  ((quote hint) "Hint")
  ((quote flymake-error) "Error")
  ((quote :error) "Error")
  ((quote flymake-warning) "Warning")
  ((quote :warning) "Warning")
  ((quote flymake-note) "Information")
  ((quote :note) "Information")
  ('_ "Information")))

(defun claude-code-ide-diagnostics---get-flycheck-diagnostics (buffer)
  "Get Flycheck diagnostics for BUFFER in VS Code format."
  (when (featurep 'flycheck)
    (with-current-buffer buffer
    (when (bound-and-true-p flycheck-mode)
    (mapcar (lambda (err)
    (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/range) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/start) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/line) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-line) (clojure-core-list 'clojure.core/err))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/character) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'if) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-column) (clojure-core-list 'clojure.core/err)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-column) (clojure-core-list 'clojure.core/err)))) (clojure-core-list 1))))))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/end) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/line) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-end-line) (clojure-core-list 'clojure.core/err)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-line) (clojure-core-list 'clojure.core/err)))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/character) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'if) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-end-column) (clojure-core-list 'clojure.core/err)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-column) (clojure-core-list 'clojure.core/err))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-end-column) (clojure-core-list 'clojure.core/err)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-column) (clojure-core-list 'clojure.core/err))))))) (clojure-core-list 1))))))))))))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/severity) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/claude-code-ide-diagnostics--severity-to-string) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-level) (clojure-core-list 'clojure.core/err)))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/source) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-checker) (clojure-core-list 'clojure.core/err)))) (clojure-core-list "flycheck"))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/message) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flycheck-error-message) (clojure-core-list 'clojure.core/err)))))))))) flycheck-current-errors)))))

(defun claude-code-ide-diagnostics---get-flymake-diagnostics (buffer)
  "Get Flymake diagnostics for BUFFER in VS Code format."
  (when (featurep 'flymake)
    (with-current-buffer buffer
    (when (bound-and-true-p flymake-mode)
    (mapcar (lambda (diag)
    (save-excursion
    (let* ((beg (flymake-diagnostic-beg diag))
        (end (flymake-diagnostic-end diag))
        (beg-line (progn
  (goto-char beg)
  (line-number-at-pos)))
        (beg-col (current-column))
        (end-line (progn
  (goto-char end)
  (line-number-at-pos)))
        (end-col (current-column)))
    (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/range) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/start) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/line) (clojure-core-list '.) (clojure-core-list 'clojure.core/beg-line)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/character) (clojure-core-list '.) (clojure-core-list 'clojure.core/beg-col)))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/end) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/line) (clojure-core-list '.) (clojure-core-list 'clojure.core/end-line)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/character) (clojure-core-list '.) (clojure-core-list 'clojure.core/end-col)))))))))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/severity) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/claude-code-ide-diagnostics--severity-to-string) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flymake-diagnostic-type) (clojure-core-list 'clojure.core/diag)))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/source) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/symbol-name) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flymake-diagnostic-backend) (clojure-core-list 'clojure.core/diag)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'quote) (clojure-core-list 'clojure.core/flymake))))))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/message) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/flymake-diagnostic-text) (clojure-core-list 'clojure.core/diag)))))))))))) (flymake-diagnostics))))))

(defun claude-code-ide-diagnostics-get-all (buffer)
  "Get diagnostics for BUFFER using configured backend.\nReturns diagnostics in VS Code format."
  (let* ((backend claude-code-ide-diagnostics-backend))
    (when (eq backend 'auto)
    (setq backend (cond
  ((and (featurep 'flycheck) (with-current-buffer buffer
    (bound-and-true-p flycheck-mode))) 'flycheck)
  ((and (featurep 'flymake) (with-current-buffer buffer
    (bound-and-true-p flymake-mode))) 'flymake)
  (t nil))))
    (or (vconcat (pcase backend
  ((quote flycheck) (claude-code-ide-diagnostics--get-flycheck-diagnostics buffer))
  ((quote flymake) (claude-code-ide-diagnostics--get-flymake-diagnostics buffer))
  ('_ nil))) (list ))))

(defun claude-code-ide-diagnostics-uri-to-file-path (uri)
  "Convert a file URI to a file path."
  (if (string-prefix-p "file://" uri) (url-unhex-string (substring uri 7)) uri))

(defun claude-code-ide-diagnostics-file-path-to-uri (file-path)
  "Convert a FILE-PATH to a file URI."
  (clel-concat "file://" (url-hexify-string file-path)))

(defun claude-code-ide-diagnostics-handler (params &optional session)
  "Handle getDiagnostics tool request with PARAMS.\nOptional SESSION contains the MCP session context."
  (let* ((uri (alist-get 'uri params))
        (diagnostics-by-file '())
        (project-dir (when session
    (claude-code-ide-mcp-session-project-dir session))))
    (claude-code-ide-debug "Diagnostics handler called with URI: %s, project-dir: %s" uri project-dir)
    (if (and uri (not (string-empty-p uri))) (let* ((file-path (claude-code-ide-diagnostics-uri-to-file-path uri))
        (buffer (get-file-buffer (expand-file-name file-path))))
    (when buffer
    (let* ((diags (claude-code-ide-diagnostics-get-all buffer)))
    (when (> (length diags) 0)
    (push (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/uri) (clojure-core-list '.) (clojure-core-list 'clojure.core/uri)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/diagnostics) (clojure-core-list '.) (clojure-core-list 'clojure.core/diags)))))) diagnostics-by-file))))) (let* ((buffer-count 0)
        (checked-count 0))
    (dolist (buffer (buffer-list))
    (when-let ((file (buffer-file-name buffer)))
    (setq buffer-count (1+ buffer-count))
    (when (or (not project-dir) (string-prefix-p (expand-file-name project-dir) (expand-file-name file)))
    (setq checked-count (1+ checked-count))
    (claude-code-ide-debug "Checking buffer: %s" file)
    (let* ((diags (claude-code-ide-diagnostics-get-all buffer)))
    (claude-code-ide-debug "Found %d diagnostics for %s" (length diags) file)
    (when (> (length diags) 0)
    (push (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/uri) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/claude-code-ide-diagnostics-file-path-to-uri) (clojure-core-list 'clojure.core/file))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/diagnostics) (clojure-core-list '.) (clojure-core-list 'clojure.core/diags)))))) diagnostics-by-file))))))
    (claude-code-ide-debug "Checked %d/%d buffers with files" checked-count buffer-count)))
    (let* ((json-str (if diagnostics-by-file (json-encode (vconcat (nreverse diagnostics-by-file))) "[]")))
    (list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/type) (clojure-core-list '.) (clojure-core-list "text")))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/text) (clojure-core-list '.) (clojure-core-list 'clojure.core/json-str))))))))))

(provide 'claude-code-ide-diagnostics)
;;; claude-code-ide-diagnostics.el ends here
