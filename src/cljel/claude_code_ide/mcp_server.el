;;; claude-code-ide-mcp-server.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'cl-lib)
(require 'json)
(require 'claude-code-ide-debug)

;;; Code:



(declare-function ws-process "web-server" (server))

(declare-function claude-code-ide-mcp-http-server-start "claude-code-ide-mcp-http-server" (handler &optional port))

(declare-function claude-code-ide-mcp-http-server-stop "claude-code-ide-mcp-http-server" (server))

(defgroup claude-code-ide-mcp-server nil
  "MCP tools server settings for Claude Code IDE."
  :group 'claude-code-ide
  :prefix "claude-code-ide-mcp-server-")

(defcustom claude-code-ide-enable-mcp-server nil
  "Enable MCP tools server for exposing Emacs functions to Claude.\nWhen enabled, a separate MCP server will be started to provide\nClaude with access to configured Emacs functions."
  :group 'claude-code-ide-mcp-server
  :type 'boolean)

(defcustom claude-code-ide-mcp-server-port nil
  "Port for the MCP tools server.\nIf nil, a random available port will be selected automatically."
  :group 'claude-code-ide-mcp-server
  :type '(choice (const :tag "Auto-select" nil) (integer :tag "Fixed port")))

(defcustom claude-code-ide-mcp-server-tools nil
  "Alist of Emacs functions to expose via MCP tools server.\nEach entry is (FUNCTION . PLIST) where PLIST contains:\n  :description - Human-readable description of the function\n  :parameters - List of parameter specifications, each with:\n    :name - Parameter name\n    :type - Parameter type (string, number, boolean)\n    :required - Whether parameter is required\n    :description - Parameter description"
  :group 'claude-code-ide-mcp-server
  :type '(alist :key-type symbol :value-type (plist :key-type keyword :value-type sexp)))

(defvar claude-code-ide-mcp-server--server nil)

(defvar claude-code-ide-mcp-server--port nil)

(defvar claude-code-ide-mcp-server--session-count 0
  "Number of active Claude sessions using the MCP tools server.")

(defvar claude-code-ide-mcp-server--sessions (make-hash-table :test 'equal)
  "Hash table mapping session IDs to session contexts.\nEach entry contains a plist with session information:\n  :project-dir - The project directory for the session\n  :buffer - The Claude Code buffer\n  :start-time - When the session was started")

(defvar claude-code-ide-mcp-server--current-session-id nil)

(defun claude-code-ide-mcp-server-make-tool (&rest slots)
  "Make a Claude Code IDE tool for MCP use.\n\nThe following keyword arguments are available:\n\nNAME: The name of the tool, recommended to be in snake_case.\n\nFUNCTION: The function itself (lambda or symbol) that runs the tool.\n\nDESCRIPTION: A verbose description of what the tool does, how to\ncall it and what it returns.\n\nARGS: A list of plists specifying the arguments, or nil for a function that\ntakes no arguments.  Each plist in ARGS should have the following keys:\n- :name - Argument name (string)\n- :type - Argument type (symbol: string, number, integer, boolean, array, object, null)\n- :description - Argument description (string)\n- :optional - Whether the argument is optional (boolean, default nil)\n- :enum - For enumerated types, a vector of allowed values\n- :items - For array types, a plist describing the array items\n- :properties - For object types, a plist of property specifications\n\nCATEGORY: A string indicating a category for the tool (optional).\n\nThe tool is automatically added to `claude-code-ide-mcp-server-tools'.\nReturns the tool specification for convenience."
  (let* ((function (plist-get slots :function))
        (name (plist-get slots :name))
        (description (plist-get slots :description))
        (args (plist-get slots :args))
        (category (plist-get slots :category)))
    (unless function
    (error "Tool :function is required"))
    (unless name
    (error "Tool :name is required"))
    (unless description
    (error "Tool :description is required"))
    (let* ((spec (list :function function :name name :description description)))
    (when args
    (setq spec (plist-put spec :args args)))
    (when category
    (setq spec (plist-put spec :category category)))
    (add-to-list 'claude-code-ide-mcp-server-tools spec)
    spec)))

(defun claude-code-ide-mcp-server---tool-format-p (tool-spec)
  "Determine format of TOOL-SPEC.\nReturns 'old for (symbol . plist) format, 'new for plist format."
  (cond
  (((and (consp tool-spec) (symbolp (car tool-spec)) (not (keywordp (car tool-spec)))) 'old) ((and (listp tool-spec) (keywordp (car tool-spec))) 'new))))

(defun claude-code-ide-mcp-server---normalize-tool-spec (tool-spec)
  "Convert TOOL-SPEC to normalized format for processing.\nHandles both old format: (func :description ... :parameters ...)\nand new format: (:function func :name ... :args ...).\nReturns a consistent plist format with :args."
  (let* ((format (claude-code-ide-mcp-server--tool-format-p tool-spec)))
    (cond
  ((eq format 'old) (let* ((func (car tool-spec))
        (plist (cdr tool-spec))
        (description (plist-get plist :description))
        (parameters (plist-get plist :parameters)))
    (message "Warning: Tool '%s' is using deprecated format. Please use `claude-code-ide-mcp-server-make-tool' instead." (symbol-name func))
    (list :function func :name (symbol-name func) :description description :args (claude-code-ide-mcp-server--parameters-to-args parameters))))
  ((eq format 'new) tool-spec)
  (t (error "Cannot normalize tool spec: %S" tool-spec)))))

(defun claude-code-ide-mcp-server---parameters-to-args (parameters)
  "Convert PARAMETERS (old format) to :args (new format).\nPARAMETERS is a list of plists with :name, :type, :description, :required.\nReturns a list of plists with :name, :type, :description, :optional."
  (mapcar (lambda (param)
    (let* ((name (plist-get param :name))
        (type (plist-get param :type))
        (description (plist-get param :description))
        (required (plist-get param :required)))
    (let* ((arg (list :name name :type (if (stringp type) (intern type) type))))
    (when description
    (setq arg (plist-put arg :description description)))
    (unless required
    (setq arg (plist-put arg :optional t)))
    (when-let ((enum (plist-get param :enum)))
    (setq arg (plist-put arg :enum enum)))
    (when-let ((items (plist-get param :items)))
    (setq arg (plist-put arg :items items)))
    (when-let ((properties (plist-get param :properties)))
    (setq arg (plist-put arg :properties properties)))
    arg))) parameters))

(defun claude-code-ide-mcp-server-ensure-server ()
  "Ensure the MCP tools server is running.\nStarts the server if not already running.\nReturns the port number on success, nil on failure."
  (when claude-code-ide-enable-mcp-server
    (unless (and claude-code-ide-mcp-server--server claude-code-ide-mcp-server--port (claude-code-ide-mcp-server--server-alive-p))
    (claude-code-ide-mcp-server--start-server))
    claude-code-ide-mcp-server--port))

(defun claude-code-ide-mcp-server-get-port ()
  "Get the port number of the running MCP tools server.\nReturns nil if server is not running."
  (when (and claude-code-ide-mcp-server--server claude-code-ide-mcp-server--port (claude-code-ide-mcp-server--server-alive-p))
    claude-code-ide-mcp-server--port))

(defun claude-code-ide-mcp-server-session-started (&optional session-id project-dir buffer)
  "Notify that a Claude session has started.\nIf SESSION-ID, PROJECT-DIR and BUFFER are provided, register the session.\nIncrements the session counter."
  (cl-incf claude-code-ide-mcp-server--session-count)
  (claude-code-ide-debug "MCP session started. Count: %d" claude-code-ide-mcp-server--session-count)
  (when (and session-id project-dir buffer)
    (claude-code-ide-mcp-server-register-session session-id project-dir buffer)))

(defun claude-code-ide-mcp-server-session-ended (&optional session-id)
  "Notify that a Claude session has ended.\nIf SESSION-ID is provided, unregister that specific session.\nDecrements the session counter and stops server if no sessions remain."
  (when session-id
    (claude-code-ide-mcp-server-unregister-session session-id))
  (when (> claude-code-ide-mcp-server--session-count 0)
    (cl-decf claude-code-ide-mcp-server--session-count)
    (claude-code-ide-debug "MCP session ended. Count: %d" claude-code-ide-mcp-server--session-count)
    (when (equal claude-code-ide-mcp-server--session-count 0)
    (claude-code-ide-mcp-server--stop-server))))

(defun claude-code-ide-mcp-server-get-config (&optional session-id)
  "Get the MCP configuration for the tools server.\nIf SESSION-ID is provided, includes it in the URL path.\nReturns an alist suitable for JSON encoding."
  (when-let ((port (claude-code-ide-mcp-server-get-port)))
    (let* ((path (if session-id (format "/mcp/%s" session-id) "/mcp"))
        (url (format "http://localhost:%d%s" port path))
        (config (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/type) (clojure-core-list '.) (clojure-core-list "http")))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/url) (clojure-core-list '.) (clojure-core-list 'clojure.core/url))))))))
    (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/mcpServers) (clojure-core-list '.) (clojure-core-list (clel-seq (clel-concat (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/emacs-tools) (clojure-core-list '.) (clojure-core-list 'clojure.core/config)))))))))))))))

(defun claude-code-ide-mcp-server-get-tool-names (&optional prefix)
  "Get a list of all registered MCP tool names.\nIf PREFIX is provided, prepend it to each tool name.\nThis is useful for generating --allowedTools lists."
  (mapcar (lambda (tool-spec)
    (let* ((normalized (claude-code-ide-mcp-server--normalize-tool-spec tool-spec))
        (tool-name (or (plist-get normalized :name) (symbol-name (plist-get normalized :function)))))
    (if prefix (clel-concat prefix tool-name) tool-name))) claude-code-ide-mcp-server-tools))

(defun claude-code-ide-mcp-server-register-session (session-id project-dir buffer)
  "Register a new session with SESSION-ID, PROJECT-DIR, and BUFFER."
  (puthash session-id (list :project-dir project-dir :buffer buffer :last-active-buffer nil :start-time (current-time)) claude-code-ide-mcp-server--sessions)
  (claude-code-ide-debug "Registered MCP session %s for project %s" session-id project-dir))

(defun claude-code-ide-mcp-server-unregister-session (session-id)
  "Unregister the session with SESSION-ID."
  (when (gethash session-id claude-code-ide-mcp-server--sessions)
    (remhash session-id claude-code-ide-mcp-server--sessions)
    (claude-code-ide-debug "Unregistered MCP session %s" session-id)))

(defun claude-code-ide-mcp-server-get-session-context (&optional session-id)
  "Get the context for SESSION-ID or the current session.\nReturns a plist with :project-dir and :buffer, or nil if not found."
  (let* ((id (or session-id claude-code-ide-mcp-server--current-session-id)))
    (when id
    (gethash id claude-code-ide-mcp-server--sessions))))

(defun claude-code-ide-mcp-server-update-last-active-buffer (session-id buffer)
  "Update the last active buffer for SESSION-ID to BUFFER.\nThis should be called when the user switches to a different buffer\nin the project to ensure MCP tools execute in the correct context."
  (when-let ((session (gethash session-id claude-code-ide-mcp-server--sessions)))
    (plist-put session :last-active-buffer buffer)
    (claude-code-ide-debug "Updated last active buffer for session %s to %s" session-id (buffer-name buffer))))

(defmacro claude-code-ide-mcp-server-with-session-context (session-id &rest body)
  "Execute BODY with the context of SESSION-ID.\nSets the default-directory to the session's project directory\nand makes the session's buffer current if it exists.\nPrefers the last active buffer over the registered buffer."
  (clel-seq (clel-concat (clojure-core-list 'let*) (clojure-core-list (apply clojure-core-vector (clel-seq (clel-concat (clojure-core-list 'clojure.core/context) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/claude-code-ide-mcp-server-get-session-context) (clojure-core-list session-id)))) (clojure-core-list 'clojure.core/project-dir) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/plist-get) (clojure-core-list 'clojure.core/context) (clojure-core-list :project-dir)))) (clojure-core-list 'clojure.core/last-active-buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/plist-get) (clojure-core-list 'clojure.core/context) (clojure-core-list :last-active-buffer)))) (clojure-core-list 'clojure.core/registered-buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/plist-get) (clojure-core-list 'clojure.core/context) (clojure-core-list :buffer)))) (clojure-core-list 'clojure.core/buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/and) (clojure-core-list 'clojure.core/last-active-buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/buffer-live-p) (clojure-core-list 'clojure.core/last-active-buffer)))) (clojure-core-list 'clojure.core/last-active-buffer)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/and) (clojure-core-list 'clojure.core/registered-buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/buffer-live-p) (clojure-core-list 'clojure.core/registered-buffer)))) (clojure-core-list 'clojure.core/registered-buffer))))))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'if) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/not) (clojure-core-list 'clojure.core/context)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/error) (clojure-core-list "No session context found for session %s") (clojure-core-list session-id)))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/let) (clojure-core-list (apply clojure-core-vector (clel-seq (clel-concat (clojure-core-list 'clojure.core/default-directory) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/or) (clojure-core-list 'clojure.core/project-dir) (clojure-core-list 'clojure.core/default-directory)))))))) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'if) (clojure-core-list 'clojure.core/buffer) (clojure-core-list (clel-seq (clel-concat (clojure-core-list 'clojure.core/with-current-buffer) (clojure-core-list 'clojure.core/buffer) body))) body))))))))))))

(defun claude-code-ide-mcp-server---server-alive-p ()
  "Check if the MCP tools server is still alive."
  (when claude-code-ide-mcp-server--server
    (condition-case nil
    (let* ((process (ws-process claude-code-ide-mcp-server--server)))
    (and process (process-live-p process)))
  (error nil))))

(defun claude-code-ide-mcp-server---start-server ()
  "Start the MCP HTTP server."
  (condition-case err
    (progn
  (require 'claude-code-ide-mcp-http-server)
  (unless (featurep 'web-server)
    (error "The web-server package is required for MCP tools support. Please install it with: M-x package-install RET web-server RET"))
  (let* ((result (claude-code-ide-mcp-http-server-start claude-code-ide-mcp-server-port)))
    (setq claude-code-ide-mcp-server--server (car result) claude-code-ide-mcp-server--port (cdr result))
    claude-code-ide-mcp-server--port))
  (error (claude-code-ide-debug "Failed to start MCP server: %s" (error-message-string err))
      (message "Warning: Failed to start MCP server: %s" (error-message-string err))
      nil)))

(defun claude-code-ide-mcp-server---stop-server ()
  "Stop the MCP HTTP server."
  (when claude-code-ide-mcp-server--server
    (condition-case err
    (progn
  (claude-code-ide-mcp-http-server-stop claude-code-ide-mcp-server--server)
  (setq claude-code-ide-mcp-server--server nil claude-code-ide-mcp-server--port nil)
  (clrhash claude-code-ide-mcp-server--sessions)
  (claude-code-ide-debug "MCP server stopped"))
  (error (claude-code-ide-debug "Error stopping MCP server: %s" (error-message-string err))))))

(provide 'claude-code-ide-mcp-server)
;;; claude-code-ide-mcp-server.el ends here
