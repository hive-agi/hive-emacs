(ns claude-code-ide-tests
  "Tests for Claude Code IDE using ERT.

Run tests with:
  emacs -batch -L . -l ert -l claude-code-ide-tests.el -f ert-run-tests-batch-and-exit

The tests mock both vterm and mcp-server-lib functionality to avoid requiring
these packages during testing."
  (:require [cl-lib]))

(require 'ert)

;; ============================================================================
;; Mock Implementations
;; ============================================================================

;; === Mock claude-code-ide-debug module ===
(defvar claude-code-ide-debug nil
  "Mock debug flag for testing.")
(defvar claude-code-ide-log-with-context t
  "Mock log context flag for testing.")
(defun claude-code-ide-debug (&rest _args)
  "Mock debug function that does nothing."
  nil)
(defun claude-code-ide-clear-debug ()
  "Mock clear debug function."
  nil)
(defun claude-code-ide-log (format-string &rest args)
  "Mock logging function for tests."
  (apply #'message format-string args))
(defun claude-code-ide--get-session-context ()
  "Mock session context function."
  "")
(provide 'claude-code-ide-debug)

;; === Mock websocket module ===
(condition-case nil
    (progn
      (add-to-list 'load-path (expand-file-name "~/.emacs.d/.cache/straight/build/websocket/"))
      (require 'websocket))
  (error
   (defun websocket-server (&rest _args)
     "Mock websocket-server function."
     '(:mock-server t))
   (defun websocket-server-close (_server)
     "Mock websocket-server-close function."
     nil)
   (defun websocket-send-text (_ws _text)
     "Mock websocket-send-text function."
     nil)
   (defun websocket-ready-state (_ws)
     "Mock websocket-ready-state function."
     'open)
   (defun websocket-url (_ws)
     "Mock websocket-url function."
     "ws://localhost:12345")
   (defun websocket-frame-text (_frame)
     "Mock websocket-frame-text function."
     "{}")
   (defun websocket-frame-opcode (_frame)
     "Mock websocket-frame-opcode function."
     'text)
   (defun websocket-send (_ws _frame)
     "Mock websocket-send function."
     nil)
   (defun websocket-server-filter (_proc _string)
     "Mock websocket-server-filter function."
     nil)
   (defvar websocket-frame nil)
   (cl-defstruct websocket-frame opcode payload)
   (provide (quote websocket))))

;; === Mock vterm module ===
(defvar vterm--process nil)
(defvar vterm-buffer-name nil)
(defvar vterm-shell nil)
(defvar vterm-environment nil)

(defun vterm (&optional buffer-name)
  "Mock vterm function for testing with optional BUFFER-NAME."
  (let [buffer (generate-new-buffer (or buffer-name vterm-buffer-name "*vterm*"))]
    (with-current-buffer buffer
      (setq vterm--process (make-process :name "mock-vterm"
                                         :buffer buffer
                                         :command '("true")
                                         :connection-type 'pty
                                         :sentinel (lambda (_ event)
                                                     (when (string-match "finished" event)
                                                       (setq vterm--process nil))))))
    buffer))

(defun vterm-send-string (_string)
  "Mock vterm-send-string function for testing."
  nil)

(defun vterm-send-return ()
  "Mock vterm-send-return function for testing."
  nil)

(defun vterm-send-key (_key &optional _shift _meta _ctrl)
  "Mock vterm-send-key function for testing."
  nil)

(provide (quote vterm))

;; === Mock Emacs display functions ===
(unless (fboundp 'display-buffer-in-side-window)
  (defun display-buffer-in-side-window (buffer _alist)
    "Mock display-buffer-in-side-window for testing."
    (set-window-buffer (selected-window) buffer)
    (selected-window)))

;; === Additional test-specific websocket mocks ===
(unless (featurep 'websocket)
  (defvar websocket--test-server nil
    "Mock server for testing.")
  (defvar websocket--test-client nil
    "Mock client for testing.")
  (defvar websocket--test-port 12345
    "Mock port for testing."))

;; === Mock flycheck module ===
(defvar flycheck-mode nil
  "Mock flycheck-mode variable.")
(defvar flycheck-current-errors nil
  "Mock list of flycheck errors.")

(cl-defstruct flycheck-error
  "Mock flycheck error structure."
  buffer checker filename line column end-line end-column
  message level severity id)

(provide (quote flycheck))

;; === Load required modules ===
(define-error 'mcp-error "MCP Error" 'error)
(require 'claude-code-ide-mcp-handlers)
(require 'claude-code-ide)

;; ============================================================================
;; Test Helper Functions
;; ============================================================================

(defmacro claude-code-ide-tests--with-mocked-cli (cli-path &rest body)
  "Execute BODY with claude CLI path set to CLI-PATH."
  `(let [claude-code-ide-cli-path ,cli-path
         claude-code-ide--cli-available nil]
     ,@body))

(defn- -with-temp-directory [test-body]
  "Execute TEST-BODY in a temporary directory context."
  (let [temp-dir (make-temp-file "claude-code-ide-test-" t)]
    (unwind-protect
        (let [default-directory temp-dir]
          (funcall test-body))
      (delete-directory temp-dir t))))

(defn- -clear-processes []
  "Clear the process hash table for testing."
  (clrhash claude-code-ide--processes)
  (when (boundp 'claude-code-ide-mcp--sessions)
    (clrhash claude-code-ide-mcp--sessions)))

(defn- -wait-for-process [buffer]
  "Wait for the process in BUFFER to finish."
  (with-current-buffer buffer
    (let [max-wait 50]
      (while (and vterm--process
                  (process-live-p vterm--process)
                  (> max-wait 0))
        (sleep-for 0.1)
        (setq max-wait (1- max-wait))))))

;; ============================================================================
;; Tests for Helper Functions
;; ============================================================================

(ert-deftest claude-code-ide-test-default-buffer-name ()
  "Test default buffer name generation for various path formats."
  (should (equal (claude-code-ide--default-buffer-name "/home/user/project")
                 "*claude-code[project]*"))
  (should (equal (claude-code-ide--default-buffer-name "/home/user/my-app/")
                 "*claude-code[my-app]*"))
  (should (equal (claude-code-ide--default-buffer-name "/")
                 "*claude-code[]*"))
  (should (equal (claude-code-ide--default-buffer-name "/home/user/my project/")
                 "*claude-code[my project]*"))
  (should (equal (claude-code-ide--default-buffer-name "/home/user/my-project@v1.0/")
                 "*claude-code[my-project@v1.0]*")))

(ert-deftest claude-code-ide-test-get-working-directory ()
  "Test working directory detection."
  (claude-code-ide-tests--with-temp-directory
   (lambda (_unused)
     (let [expected (expand-file-name default-directory)]
       (should (equal (claude-code-ide--get-working-directory) expected))))))

(ert-deftest claude-code-ide-test-get-buffer-name ()
  "Test buffer name generation using custom function."
  (let [claude-code-ide-buffer-name-function
        (lambda (dir) (format "test-%s" (file-name-nondirectory dir)))]
    (claude-code-ide-tests--with-temp-directory
     (lambda (_unused)
       (should (string-match "^test-claude-code-ide-test-"
                             (claude-code-ide--get-buffer-name))))))
  (let [claude-code-ide-buffer-name-function
        (lambda (dir) (if dir
                          (format "*custom[%s]*" (file-name-nondirectory dir))
                        "*custom[none]*"))]
    (should (equal (funcall claude-code-ide-buffer-name-function nil)
                   "*custom[none]*"))))

(ert-deftest claude-code-ide-test-process-management ()
  "Test process storage and retrieval."
  (claude-code-ide-tests--clear-processes)
  (unwind-protect
      (claude-code-ide-tests--with-temp-directory
       (lambda (_unused)
         (let [dir (claude-code-ide--get-working-directory)
               mock-process 'mock-process]
           (should (null (claude-code-ide--get-process dir)))
           (claude-code-ide--set-process mock-process dir)
           (should (eq (claude-code-ide--get-process dir) mock-process))
           (should (eq (claude-code-ide--get-process) mock-process)))))
    (claude-code-ide-tests--clear-processes)))

(ert-deftest claude-code-ide-test-cleanup-dead-processes ()
  "Test cleanup of dead processes."
  (claude-code-ide-tests--clear-processes)
  (unwind-protect
      (let* [live-process (make-process :name "test-live"
                                        :command '("sleep" "10")
                                        :buffer nil)
             dead-process-name "test-dead"]
        (puthash "/dir1" live-process claude-code-ide--processes)
        (puthash "/dir2" dead-process-name claude-code-ide--processes)
        (should (= (hash-table-count claude-code-ide--processes) 2))
        (claude-code-ide--cleanup-dead-processes)
        (should (= (hash-table-count claude-code-ide--processes) 1))
        (should (gethash "/dir1" claude-code-ide--processes))
        (should (null (gethash "/dir2" claude-code-ide--processes)))
        (delete-process live-process))
    (claude-code-ide-tests--clear-processes)))

;; ============================================================================
;; Tests for CLI Detection
;; ============================================================================

(ert-deftest claude-code-ide-test-detect-cli ()
  "Test CLI detection mechanism."
  (let [claude-code-ide--cli-available nil]
    (let [claude-code-ide-cli-path "nonexistent-claude-cli"]
      (claude-code-ide--detect-cli)
      (should (null claude-code-ide--cli-available)))
    (let [claude-code-ide-cli-path "echo"]
      (claude-code-ide--detect-cli)
      (should claude-code-ide--cli-available))))

(ert-deftest claude-code-ide-test-ensure-cli ()
  "Test CLI availability checking."
  (let [claude-code-ide--cli-available nil
        claude-code-ide-cli-path "echo"]
    (should (null claude-code-ide--cli-available))
    (should (claude-code-ide--ensure-cli))
    (should claude-code-ide--cli-available)))

;; ============================================================================
;; Command Tests
;; ============================================================================

(ert-deftest claude-code-ide-test-run-without-cli ()
  "Test run command when CLI is not available."
  (let [claude-code-ide--cli-available nil
        claude-code-ide-cli-path "nonexistent-claude-cli"]
    (should-error (claude-code-ide)
                  :type 'user-error)))

(ert-deftest claude-code-ide-test-run-without-vterm ()
  "Test run command when vterm is not available."
  (let [claude-code-ide--cli-available t
        claude-code-ide-cli-path "echo"
        claude-code-ide-terminal-backend 'vterm
        orig-featurep (symbol-function 'featurep)]
    (cl-letf (((symbol-function 'featurep)
               (lambda (sym &rest _) (if (eq sym 'vterm) nil (funcall orig-featurep sym))))
              ((symbol-function 'require)
               (lambda (feature &optional filename noerror)
                 (unless (eq feature 'vterm)
                   (require feature filename noerror)))))
      (should-error (claude-code-ide)
                    :type 'user-error))))

(ert-deftest claude-code-ide-test-run-without-eat ()
  "Test run command when eat is not available."
  (let [claude-code-ide--cli-available t
        claude-code-ide-cli-path "echo"
        claude-code-ide-terminal-backend 'eat
        orig-featurep (symbol-function 'featurep)]
    (cl-letf (((symbol-function 'featurep)
               (lambda (sym &rest _) (if (eq sym 'eat) nil (funcall orig-featurep sym))))
              ((symbol-function 'require)
               (lambda (feature &optional filename noerror)
                 (unless (eq feature 'eat)
                   (require feature filename noerror)))))
      (should-error (claude-code-ide)
                    :type 'user-error))))

(ert-deftest claude-code-ide-test-terminal-backend-selection ()
  "Test terminal backend selection and validation."
  (let [claude-code-ide-terminal-backend 'vterm]
    (should (eq claude-code-ide-terminal-backend 'vterm)))
  (let [claude-code-ide-terminal-backend 'eat]
    (should (eq claude-code-ide-terminal-backend 'eat)))
  (let [claude-code-ide-terminal-backend 'invalid-backend
        orig-featurep (symbol-function 'featurep)]
    (cl-letf (((symbol-function 'featurep)
               (lambda (sym) nil)))
      (should-error (claude-code-ide--terminal-ensure-backend)
                    :type 'user-error))))

(ert-deftest claude-code-ide-test-terminal-send-functions ()
  "Test terminal send wrapper functions."
  (let [vterm-string-sent nil
        vterm-escape-sent nil
        vterm-return-sent nil
        eat-string-sent nil]
    (cl-letf (((symbol-function 'vterm-send-string)
               (lambda (str) (setq vterm-string-sent str)))
              ((symbol-function 'vterm-send-escape)
               (lambda () (setq vterm-escape-sent t)))
              ((symbol-function 'vterm-send-return)
               (lambda () (setq vterm-return-sent t)))
              ((symbol-function 'eat-term-send-string)
               (lambda (term str) (setq eat-string-sent str))))
      (let [claude-code-ide-terminal-backend 'vterm]
        (claude-code-ide--terminal-send-string "test")
        (should (equal vterm-string-sent "test"))
        (claude-code-ide--terminal-send-escape)
        (should vterm-escape-sent)
        (claude-code-ide--terminal-send-return)
        (should vterm-return-sent))
      (with-temp-buffer
        (let [claude-code-ide-terminal-backend 'eat]
          (setq-local eat-terminal t)
          (claude-code-ide--terminal-send-string "test")
          (should (equal eat-string-sent "test"))
          (setq eat-string-sent nil)
          (claude-code-ide--terminal-send-escape)
          (should (equal eat-string-sent "\e"))
          (setq eat-string-sent nil)
          (claude-code-ide--terminal-send-return)
          (should (equal eat-string-sent "\r")))))))

(ert-deftest claude-code-ide-test-check-status ()
  "Test status check command."
  (let [claude-code-ide-cli-path "echo"
        claude-code-ide--cli-available nil]
    (claude-code-ide-check-status)
    (should claude-code-ide--cli-available)))

(ert-deftest claude-code-ide-test-stop-no-session ()
  "Test stop command when no session is running."
  (claude-code-ide-tests--clear-processes)
  (unwind-protect
      (claude-code-ide-tests--with-temp-directory
       (lambda (_unused)
         (claude-code-ide-stop)))
    (claude-code-ide-tests--clear-processes)))

(ert-deftest claude-code-ide-test-switch-to-buffer-no-session ()
  "Test switch-to-buffer command when no session exists."
  (claude-code-ide-tests--clear-processes)
  (unwind-protect
      (should-error (claude-code-ide-switch-to-buffer)
                    :type 'user-error)
    (claude-code-ide-tests--clear-processes)))

(ert-deftest claude-code-ide-test-list-sessions-empty ()
  "Test listing sessions when none exist."
  (claude-code-ide-tests--clear-processes)
  (unwind-protect
      (claude-code-ide-list-sessions)
    (claude-code-ide-tests--clear-processes)))

(ert-deftest claude-code-ide-test-debug-mode-flag ()
  "Test debug mode CLI flag."
  (let [claude-code-ide-cli-debug t]
    (should (string-match "-d" (claude-code-ide--build-claude-command)))
    (should (string-match "-d.*-c" (claude-code-ide--build-claude-command t)))
    (should (string-match "-d.*-r" (claude-code-ide--build-claude-command nil t)))))

(ert-deftest claude-code-ide-test-error-handling ()
  "Test error handling in various scenarios."
  (let [claude-code-ide-cli-path nil
        claude-code-ide--cli-available nil]
    (should-error (claude-code-ide) :type 'user-error))
  (let [claude-code-ide-cli-path ""
        claude-code-ide--cli-available nil]
    (should-error (claude-code-ide) :type 'user-error)))

(ert-deftest claude-code-ide-test-window-placement-options ()
  "Test different window placement configurations."
  (dolist (side '(left right top bottom))
    (let [claude-code-ide-window-side side]
      (should (eq claude-code-ide-window-side side)))))

(defn run-tests []
  "Run all claude-code-ide test cases."
  (interactive)
  (ert-run-tests-batch-and-exit "^claude-code-ide-test-"))

(defn run-all-tests []
  "Run all claude-code-ide tests including MCP tests."
  (interactive)
  (ert-run-tests-batch-and-exit "^claude-code-ide-"))

;; ============================================================================
;; MCP Tests
;; ============================================================================

(require 'claude-code-ide-mcp)
(require 'claude-code-ide-mcp-handlers)

(condition-case nil
    (require 'claude-code-ide-mcp-server)
  (error nil))

;; ============================================================================
;; MCP Test Helper Functions
;; ============================================================================

(defmacro claude-code-ide-mcp-tests--with-temp-file (file-var content &rest body)
  "Create a temporary file with CONTENT, bind its path to FILE-VAR, and execute BODY."
  (declare (indent 2))
  `(let [~file-var (make-temp-file "claude-mcp-test-")]
     (unwind-protect
         (progn
           (with-temp-file ~file-var
             (insert ~content))
           ,@body)
       (delete-file ~file-var))))

(defmacro claude-code-ide-mcp-tests--with-temp-buffer (content &rest body)
  "Create a temporary buffer with CONTENT and execute BODY."
  (declare (indent 1))
  `(with-temp-buffer
     (insert ~content)
     (goto-char (point-min))
     ,@body))

;; ============================================================================
;; Tests for MCP Tool Implementations
;; ============================================================================

(ert-deftest claude-code-ide-test-mcp-open-file ()
  "Test the openFile tool implementation."
  (claude-code-ide-mcp-tests--with-temp-file test-file "Line 1\nLine 2\nLine 3\nLine 4"
    (let [result (claude-code-ide-mcp-handle-open-file `((path . ,test-file)))]
      (should (listp result))
      (let [first-item (car result)]
        (should (equal (alist-get 'type first-item) "text"))
        (should (equal (alist-get 'text first-item) "FILE_OPENED")))
      (should (equal (buffer-file-name) test-file))
      (kill-buffer)))
  (should-error (claude-code-ide-mcp-handle-open-file '())
                :type 'mcp-error))

(ert-deftest claude-code-ide-test-mcp-get-current-selection ()
  "Test the getCurrentSelection tool implementation."
  (claude-code-ide-mcp-tests--with-temp-buffer "Line 1\nLine 2\nLine 3"
    (goto-char (point-min))
    (set-mark (point))
    (forward-line 2)
    (let [transient-mark-mode t]
      (activate-mark)
      (let [result (claude-code-ide-mcp-handle-get-current-selection nil)]
        (should (equal (alist-get 'text result) "Line 1\nLine 2\n"))
        (let [selection (alist-get 'selection result)]
          (should selection)
          (let [start (alist-get 'start selection)
                end (alist-get 'end selection)]
            (should (= (alist-get 'line start) 1))
            (should (= (alist-get 'line end) 3)))))))
  (claude-code-ide-mcp-tests--with-temp-buffer "Test"
    (let [result (claude-code-ide-mcp-handle-get-current-selection nil)]
      (should (equal (alist-get 'text result) ""))
      (let [selection (alist-get 'selection result)]
        (should selection)
        (should (alist-get 'isEmpty selection))))))

(ert-deftest claude-code-ide-test-mcp-tool-registry ()
  "Test that all tools are properly registered."
  (let* [base-tools '("openFile" "getCurrentSelection" "getOpenEditors"
                      "getWorkspaceFolders" "getDiagnostics" "saveDocument"
                      "close_tab" "checkDocumentDirty")
         diff-tools (when (bound-and-true-p claude-code-ide-use-ide-diff)
                      '("openDiff" "closeAllDiffTabs"))
         expected-tools (append base-tools diff-tools)]
    (setq claude-code-ide-mcp-tools (claude-code-ide-mcp--build-tool-list))
    (setq claude-code-ide-mcp-tool-schemas (claude-code-ide-mcp--build-tool-schemas))
    (setq claude-code-ide-mcp-tool-descriptions (claude-code-ide-mcp--build-tool-descriptions))
    (dolist (tool-name expected-tools)
      (should (alist-get tool-name claude-code-ide-mcp-tools nil nil #'string=))
      (let [handler (alist-get tool-name claude-code-ide-mcp-tools nil nil #'string=)
            schema (alist-get tool-name claude-code-ide-mcp-tool-schemas nil nil #'string=)]
        (should (or (functionp handler)
                    (and (symbolp handler) (fboundp handler))))
        (should schema)))))

(ert-deftest claude-code-ide-test-mcp-server-lifecycle ()
  "Test MCP server start and stop."
  (require 'claude-code-ide-mcp)
  (unwind-protect
      (progn
        (let [port (claude-code-ide-mcp-start)]
          (should (numberp port))
          (should (>= port 10000))
          (should (<= port 65535))
          (should (file-exists-p (claude-code-ide-mcp--lockfile-path port)))
          (claude-code-ide-mcp-stop)
          (should-not (file-exists-p (claude-code-ide-mcp--lockfile-path port)))))
    (claude-code-ide-mcp-stop)))

;; ============================================================================
;; Tests for Diagnostics
;; ============================================================================

(ert-deftest claude-code-ide-test-diagnostics-severity-mapping ()
  "Test diagnostic severity conversion."
  (require 'claude-code-ide-diagnostics)
  (should (= (claude-code-ide-diagnostics--severity-to-vscode 'error) 1))
  (should (= (claude-code-ide-diagnostics--severity-to-vscode 'warning) 2))
  (should (= (claude-code-ide-diagnostics--severity-to-vscode 'info) 3))
  (should (= (claude-code-ide-diagnostics--severity-to-vscode 'hint) 4))
  (should (= (claude-code-ide-diagnostics--severity-to-vscode 'unknown) 3)))

(ert-deftest claude-code-ide-test-diagnostics-severity-to-string ()
  "Test severity to string conversion."
  (require 'claude-code-ide-diagnostics)
  (should (equal (claude-code-ide-diagnostics--severity-to-string 'error) "Error"))
  (should (equal (claude-code-ide-diagnostics--severity-to-string 'warning) "Warning"))
  (should (equal (claude-code-ide-diagnostics--severity-to-string 'info) "Information"))
  (should (equal (claude-code-ide-diagnostics--severity-to-string 'hint) "Hint"))
  (should (equal (claude-code-ide-diagnostics--severity-to-string 'unknown) "Information")))

(ert-deftest claude-code-ide-test-diagnostics-handler ()
  "Test getDiagnostics handler."
  (require 'claude-code-ide-diagnostics)
  (let [result (claude-code-ide-diagnostics-handler nil)]
    (should (listp result))
    (should (equal (alist-get 'type (car result)) "text"))
    (should (equal (alist-get 'text (car result)) "[]"))))

(ert-deftest claude-code-ide-test-check-document-dirty ()
  "Test checkDocumentDirty handler."
  (require 'claude-code-ide-mcp-handlers)
  (with-temp-buffer
    (setq buffer-file-name "/tmp/test-file.el")
    (insert "test content")
    (set-buffer-modified-p t)
    (let [result (claude-code-ide-mcp-handle-check-document-dirty
                  '((filePath . "/tmp/test-file.el")))]
      (should (eq (alist-get 'isDirty result) t))))
  (with-temp-buffer
    (setq buffer-file-name "/tmp/test-file2.el")
    (insert "test content")
    (set-buffer-modified-p nil)
    (let [result (claude-code-ide-mcp-handle-check-document-dirty
                  '((filePath . "/tmp/test-file2.el")))]
      (should (eq (alist-get 'isDirty result) :json-false))))
  (let [result (claude-code-ide-mcp-handle-check-document-dirty
                '((filePath . "/tmp/non-existent-file.el")))]
    (should (eq (alist-get 'isDirty result) :json-false)))
  (should-error (claude-code-ide-mcp-handle-check-document-dirty '())
                :type 'mcp-error))

;; ============================================================================
;; MCP Tools Server Tests
;; ============================================================================

(defvar claude-code-ide-mcp-server-tests--mock-server-started nil)
(defvar claude-code-ide-mcp-server-tests--mock-server-port 12345)

(defn- -mock-server-start [&optional _port]
  "Mock server start function."
  (setq claude-code-ide-mcp-server-tests--mock-server-started t)
  (cons 'mock-process claude-code-ide-mcp-server-tests--mock-server-port))

(defn- -mock-server-stop [_process]
  "Mock server stop function."
  (setq claude-code-ide-mcp-server-tests--mock-server-started nil))

(defvar claude-code-ide-mcp-server-tests--last-response nil)
(defvar claude-code-ide-mcp-server-tests--last-response-headers nil)
(defvar claude-code-ide-mcp-server-tests--last-response-status nil)

(cl-defstruct claude-code-ide-mcp-server-tests--mock-request
  process headers body)

(cl-defstruct claude-code-ide-mcp-server-tests--mock-process)

(ert-deftest claude-code-ide-mcp-server-test-session-lifecycle ()
  "Test MCP tools server session lifecycle."
  (let [claude-code-ide-enable-mcp-server t
        claude-code-ide-mcp-server--session-count 0
        claude-code-ide-mcp-server--server nil
        claude-code-ide-mcp-server--port nil]
    (cl-letf (((symbol-function 'claude-code-ide-mcp-http-server-start)
               #'claude-code-ide-mcp-server-tests--mock-server-start)
              ((symbol-function 'claude-code-ide-mcp-http-server-stop)
               #'claude-code-ide-mcp-server-tests--mock-server-stop)
              ((symbol-function 'require)
               (lambda (feature &optional _filename _noerror)
                 (cond ((eq feature 'claude-code-ide-mcp-http-server) nil)
                       ((memq feature '(claude-code-ide-mcp-server websocket vterm flycheck
                                        claude-code-ide-debug claude-code-ide-mcp-handlers
                                        claude-code-ide transient)) nil)
                       (t (funcall (cl-letf-saved-symbol-function 'require) feature _filename _noerror))))))
      (claude-code-ide-mcp-server-session-started)
      (should (= claude-code-ide-mcp-server--session-count 1))
      (setq claude-code-ide-mcp-server--server
            (car (claude-code-ide-mcp-server-tests--mock-server-start)))
      (setq claude-code-ide-mcp-server--port
            (cdr (claude-code-ide-mcp-server-tests--mock-server-start)))
      (should claude-code-ide-mcp-server--server)
      (should (= claude-code-ide-mcp-server--port
                 claude-code-ide-mcp-server-tests--mock-server-port))
      (claude-code-ide-mcp-server-session-started)
      (should (= claude-code-ide-mcp-server--session-count 2))
      (claude-code-ide-mcp-server-session-ended)
      (should (= claude-code-ide-mcp-server--session-count 1))
      (should claude-code-ide-mcp-server--server)
      (claude-code-ide-mcp-server-session-ended)
      (should (= claude-code-ide-mcp-server--session-count 0))
      (claude-code-ide-mcp-server-tests--mock-server-stop claude-code-ide-mcp-server--server)
      (setq claude-code-ide-mcp-server--server nil)
      (setq claude-code-ide-mcp-server--port nil)
      (should-not claude-code-ide-mcp-server--server)
      (should-not claude-code-ide-mcp-server--port))))

(ert-deftest claude-code-ide-mcp-server-test-config-generation ()
  "Test MCP configuration generation."
  (let [claude-code-ide-enable-mcp-server t
        claude-code-ide-mcp-server--server 'mock-server
        claude-code-ide-mcp-server--port 8080]
    (cl-letf (((symbol-function 'process-live-p) (lambda (_) t))
              ((symbol-function 'ws-process) (lambda (_) 'mock-process)))
      (let [config (claude-code-ide-mcp-server-get-config)]
        (should config)
        (should (equal (alist-get 'type (alist-get 'emacs-tools (alist-get 'mcpServers config)))
                       "http"))
        (should (equal (alist-get 'url (alist-get 'emacs-tools (alist-get 'mcpServers config)))
                       "http://localhost:8080/mcp"))))
    (let [claude-code-ide-mcp-server--server nil
          claude-code-ide-mcp-server--port nil
          config (claude-code-ide-mcp-server-get-config)]
      (should-not config))))

(ert-deftest claude-code-ide-mcp-server-test-disabled ()
  "Test that MCP tools server does nothing when disabled."
  (let [claude-code-ide-enable-mcp-server nil
        claude-code-ide-mcp-server--session-count 0]
    (should-not (claude-code-ide-mcp-server-ensure-server))
    (claude-code-ide-mcp-server-session-started)
    (should (= claude-code-ide-mcp-server--session-count 1))
    (should-not claude-code-ide-mcp-server--server)))

(ert-deftest claude-code-ide-mcp-server-test-tool-config ()
  "Test tool configuration structure."
  (let [claude-code-ide-mcp-server-tools
        '((test-function
           :description "Test function"
           :parameters ((:name "arg1" :type "string" :required t)
                        (:name "arg2" :type "number" :required nil))))]
    (let* [tool (car claude-code-ide-mcp-server-tools)
           name (car tool)
           plist (cdr tool)]
      (should (eq name 'test-function))
      (should (equal (plist-get plist :description) "Test function"))
      (should (= (length (plist-get plist :parameters)) 2)))))

(ert-deftest claude-code-ide-mcp-server-test-json-encoding ()
  "Test JSON encoding of MCP config."
  (let [config '((mcpServers . ((emacs-tools . ((transport . "http")
                                                (url . "http://localhost:8080/mcp"))))))]
    (let [json-str (json-encode config)]
      (should (stringp json-str))
      (should (string-match "mcpServers" json-str))
      (should (string-match "emacs-tools" json-str))
      (should (string-match "transport.*:.*http" json-str)))))

;; ============================================================================
;; MCP Server Session Context Tests
;; ============================================================================

(ert-deftest claude-code-ide-mcp-server-test-session-registration ()
  "Test session registration and retrieval."
  (let [session-id "test-session-123"
        project-dir "/tmp/test-project"
        buffer (get-buffer-create "*test-buffer*")]
    (unwind-protect
        (progn
          (claude-code-ide-mcp-server-register-session session-id project-dir buffer)
          (let [context (gethash session-id claude-code-ide-mcp-server--sessions)]
            (should context)
            (should (equal (plist-get context :project-dir) project-dir))
            (should (eq (plist-get context :buffer) buffer))
            (should (plist-get context :start-time)))
          (let [claude-code-ide-mcp-server--current-session-id session-id]
            (let [context (claude-code-ide-mcp-server-get-session-context)]
              (should context)
              (should (equal (plist-get context :project-dir) project-dir))))
          (claude-code-ide-mcp-server-unregister-session session-id)
          (should-not (gethash session-id claude-code-ide-mcp-server--sessions)))
      (kill-buffer buffer)
      (clrhash claude-code-ide-mcp-server--sessions))))

(ert-deftest claude-code-ide-mcp-server-test-session-lifecycle-detailed ()
  "Test complete session lifecycle with detailed tracking."
  (let [session-id "test-session-789"
        project-dir "/tmp/test-project-3"
        buffer (get-buffer-create "*test-buffer-3*")]
    (unwind-protect
        (progn
          (claude-code-ide-mcp-server-session-started session-id project-dir buffer)
          (should (= claude-code-ide-mcp-server--session-count 1))
          (should (gethash session-id claude-code-ide-mcp-server--sessions))
          (claude-code-ide-mcp-server-session-ended session-id)
          (should (= claude-code-ide-mcp-server--session-count 0))
          (should-not (gethash session-id claude-code-ide-mcp-server--sessions)))
      (kill-buffer buffer)
      (setq claude-code-ide-mcp-server--session-count 0)
      (clrhash claude-code-ide-mcp-server--sessions))))

(ert-deftest claude-code-ide-mcp-server-test-config-with-session-id ()
  "Test MCP config generation with session ID."
  (cl-letf (((symbol-function 'claude-code-ide-mcp-server-get-port)
             (lambda () 12345)))
    (let [config (claude-code-ide-mcp-server-get-config)]
      (should config)
      (let [url (alist-get 'url (alist-get 'emacs-tools (alist-get 'mcpServers config)))]
        (should (equal url "http://localhost:12345/mcp"))))
    (let [config (claude-code-ide-mcp-server-get-config "my-session-123")]
      (should config)
      (let* [emacs-tools (alist-get 'emacs-tools (alist-get 'mcpServers config))
             url (alist-get 'url emacs-tools)]
        (should (equal url "http://localhost:12345/mcp/my-session-123"))))))

;; ============================================================================
;; Emacs Tools Tests
;; ============================================================================

(ert-deftest claude-code-ide-emacs-tools-test-imenu-list-symbols ()
  "Test the imenu-list-symbols MCP tool."
  (require 'claude-code-ide-emacs-tools)
  (let [test-file (make-temp-file "test-imenu-" nil ".el")
        session-id "test-session-imenu"
        project-dir (temporary-file-directory)]
    (unwind-protect
        (progn
          (with-temp-file test-file
            (insert ";;; Test file for imenu\n\n"
                    "(defun test-function-1 (arg)\n"
                    "  \"A test function.\"\n"
                    "  (message \"Hello %s\" arg))\n\n"
                    "(defvar test-variable 42\n"
                    "  \"A test variable.\")\n\n"
                    "(defun test-function-2 ()\n"
                    "  \"Another test function.\"\n"
                    "  (+ 1 2))\n\n"
                    "(defconst test-constant 'foo\n"
                    "  \"A test constant.\")\n"))
          (claude-code-ide-mcp-server-register-session session-id project-dir nil)
          (let [claude-code-ide-mcp-server--current-session-id session-id]
            (let [result (claude-code-ide-mcp-imenu-list-symbols test-file)]
              (should (listp result))
              (should (> (length result) 0))
              (let [result-string (mapconcat #'identity result "\n")]
                (should (string-match "test-function-1" result-string))
                (should (string-match "test-function-2" result-string))
                (should (string-match "test-variable" result-string))
                (should (string-match "test-constant" result-string))
                (should (string-match ":[0-9]+:" result-string)))))
          (should-error (claude-code-ide-mcp-imenu-list-symbols nil)
                        :type 'error))
      (delete-file test-file)
      (claude-code-ide-mcp-server-unregister-session session-id))))
