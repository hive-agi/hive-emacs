;;; hive-mcp-swarm-prompts.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'cl-lib)

(declare-function vterm-send-string "vterm")

(declare-function vterm-send-return "vterm")

(declare-function eat-term-send-string "eat")

(declare-function hive-mcp-swarm-events-emit-prompt-shown "hive-mcp-swarm-events")

(defgroup hive-mcp-swarm-prompts nil
  "Prompt handling for swarm."
  :group 'hive-mcp-swarm
  :prefix "hive-mcp-swarm-prompts-")

(defcustom hive-mcp-swarm-prompts-auto-approve t
  "If non-nil, automatically approve tool permission prompts in auto mode."
  :group 'hive-mcp-swarm-prompts
  :type 'boolean)

(defcustom hive-mcp-swarm-prompts-patterns '("Allow\\|Deny" "Yes\\|No" "(y/n)" "[Y/n]" "[y/N]" "Do you want to" "Would you like to" "Proceed\\?" "Allow .* tool" "permission" "approve\\|reject" "continue\\?" "Accept" "Allow once\\|Allow always" "Press Enter\\|Press any key")
  "Patterns that indicate a permission/confirmation prompt."
  :group 'hive-mcp-swarm-prompts
  :type '(repeat string))

(defcustom hive-mcp-swarm-prompts-mode 'human
  "How to handle permission prompts in slaves.\n- `bypass': Use --permission-mode bypassPermissions (no prompts)\n- `auto': Timer-based auto-approve (legacy behavior)\n- `human': Forward prompts to master for human decision (default)"
  :group 'hive-mcp-swarm-prompts
  :type '(choice (const :tag "Bypass permissions (CLI flag)" bypass) (const :tag "Auto-approve (timer)" auto) (const :tag "Human decision (hooks, default)" human)))

(defcustom hive-mcp-swarm-prompts-notify t
  "If non-nil, show notification when prompts are pending in human mode."
  :group 'hive-mcp-swarm-prompts
  :type 'boolean)

(defcustom hive-mcp-swarm-prompts-desktop-notify t
  "If non-nil, send desktop notification via notify-send for prompts."
  :group 'hive-mcp-swarm-prompts
  :type 'boolean)

(defcustom hive-mcp-swarm-prompts-buffer-name "*Swarm Prompts*"
  "Buffer name for displaying pending prompts."
  :group 'hive-mcp-swarm-prompts
  :type 'string)

(defvar hive-mcp-swarm-prompts--timer nil
  "Timer for auto-approve watcher.")

(defvar hive-mcp-swarm-prompts--last-positions (make-hash-table :test 'equal)
  "Hash of slave-id -> last checked position to avoid re-approving.")

(defvar hive-mcp-swarm-prompts--pending nil
  "List of pending prompts awaiting human decision.\nEach entry is plist: (:slave-id ID :prompt TEXT :buffer BUF :timestamp TIME)")

(defun hive-mcp-swarm-prompts---check-for-prompt (buffer)
  "Check BUFFER for permission prompts and return position if found."
  (when (buffer-live-p buffer)
    (with-current-buffer buffer
    (save-excursion
    (goto-char (point-max))
    (let* ((search-start (max (point-min) (- (point-max) 500))))
    (goto-char search-start)
    (cl-loop for pattern in hive-mcp-swarm-prompts-patterns when (re-search-forward pattern nil t) return (point)))))))

(defun hive-mcp-swarm-prompts---extract-prompt (buffer)
  "Extract prompt text and position from BUFFER.\nReturns plist (:text TEXT :pos POS) or nil."
  (when (buffer-live-p buffer)
    (with-current-buffer buffer
    (save-excursion
    (goto-char (point-max))
    (let* ((search-start (max (point-min) (- (point-max) 500))))
    (when (re-search-backward (regexp-opt hive-mcp-swarm-prompts-patterns) search-start t)
    (let* ((line-start (line-beginning-position))
        (line-end (line-end-position)))
    (hive-mcp-swarm-prompts-list :text (buffer-substring-no-properties line-start line-end) :pos (match-beginning 0)))))))))

(defun hive-mcp-swarm-prompts---slave-active-p (slave buffer)
  "Return t if SLAVE with BUFFER is ready for prompts."
  (and (buffer-live-p buffer) (memq (plist-get slave :status) '(working idle spawning))))

(defun hive-mcp-swarm-prompts---prompt-is-new-p (prompt-pos last-pos)
  "Return t if PROMPT-POS indicates a new prompt after LAST-POS."
  (and prompt-pos (> prompt-pos last-pos)))

(defun hive-mcp-swarm-prompts---already-queued-p (slave-id)
  "Return t if SLAVE-ID already has a pending prompt in queue."
  (cl-find slave-id hive-mcp-swarm-prompts--pending :key (lambda (p)
    (plist-get p :slave-id)) :test #'equal))

(defun hive-mcp-swarm-prompts---send-approval (buffer term-type)
  "Send 'y' approval to BUFFER using TERM-TYPE."
  (when (buffer-live-p buffer)
    (with-current-buffer buffer
    (goto-char (point-max))
    (pcase term-type
  ((quote vterm) (vterm-send-string "y") (run-at-time 0.05 nil (lambda (_unused)
    (condition-case err
    (when (buffer-live-p buffer)
    (with-current-buffer buffer
    (vterm-send-return)))
  (error (message "[swarm-prompts] Timer error in vterm approval: %s" (error-message-string err)))))))
  ((quote eat) (when (and (boundp 'eat-terminal) eat-terminal)
    (eat-term-send-string eat-terminal "y")
    (run-at-time 0.05 nil (lambda (_unused)
    (condition-case err
    (when (and (buffer-live-p buffer) (boundp 'eat-terminal) eat-terminal)
    (eat-term-send-string eat-terminal "\r"))
  (error (message "[swarm-prompts] Timer error in eat approval: %s" (error-message-string err))))))))))))

(defun hive-mcp-swarm-prompts---process-auto-approve (slave-id slave get-terminal-fn)
  "Process auto-approve for SLAVE with SLAVE-ID.\nGET-TERMINAL-FN extracts terminal type from slave plist.\nReturns t if a prompt was auto-approved, nil otherwise."
  (let* ((buffer (plist-get slave :buffer))
        (term-type (funcall get-terminal-fn slave))
        (last-pos (gethash slave-id hive-mcp-swarm-prompts--last-positions 0)))
    (when (hive-mcp-swarm-prompts---slave-active-p slave buffer)
    (let* ((prompt-pos (hive-mcp-swarm-prompts---check-for-prompt buffer)))
    (when (hive-mcp-swarm-prompts---prompt-is-new-p prompt-pos last-pos)
    (message "[swarm-prompts] Auto-approving prompt in %s" slave-id)
    (puthash slave-id prompt-pos hive-mcp-swarm-prompts--last-positions)
    (hive-mcp-swarm-prompts---send-approval buffer term-type)
    t)))))

(defun hive-mcp-swarm-prompts---auto-tick (slaves-hash get-terminal-fn)
  "Check all slave buffers for prompts in auto mode.\nSLAVES-HASH is hash table of slave-id -> slave plist.\nGET-TERMINAL-FN takes slave plist and returns terminal type symbol."
  (when hive-mcp-swarm-prompts-auto-approve
    (maphash (lambda (slave-id slave)
    (hive-mcp-swarm-prompts---process-auto-approve slave-id slave get-terminal-fn)) slaves-hash)))

(defun hive-mcp-swarm-prompts---send-desktop-notification (title body)
  "Send desktop notification with TITLE and BODY via notify-send.\nFalls back to beep + message if notify-send unavailable."
  (if (and hive-mcp-swarm-prompts-desktop-notify (executable-find "notify-send")) (start-process "swarm-notify" nil "notify-send" "--urgency=critical" "--app-name=Swarm" title body) (ding t)))

(defun hive-mcp-swarm-prompts---display-prompt (slave-id prompt-text)
  "Display PROMPT-TEXT from SLAVE-ID in the prompts buffer."
  (let* ((buf (get-buffer-create hive-mcp-swarm-prompts-buffer-name)))
    (with-current-buffer buf
    (goto-char (point-max))
    (insert (format "\n[%s] %s\n  %s\n" (format-time-string "%H:%M:%S") slave-id prompt-text))
    (insert "  -> Awaiting response (C-c m s y/n/p or MCP tool)\n"))
    (display-buffer buf '(display-buffer-in-side-window (side . bottom) (slot . 0) (window-height . 8)))))

(defun hive-mcp-swarm-prompts---queue-prompt (slave-id prompt-text buffer)
  "Add a prompt to the pending queue and notify user.\nEmits prompt-shown event via channel for push-based updates."
  (push (hive-mcp-swarm-prompts-list :slave-id slave-id :prompt prompt-text :buffer buffer :timestamp (current-time)) hive-mcp-swarm-prompts--pending)
  (hive-mcp-swarm-prompts---display-prompt slave-id prompt-text)
  (when hive-mcp-swarm-prompts-notify
    (message "[swarm-prompts] Prompt from %s: %s" slave-id (truncate-string-to-width prompt-text 50)))
  (hive-mcp-swarm-prompts---send-desktop-notification (format "Swarm Prompt: %s" slave-id) (truncate-string-to-width prompt-text 100))
  (when (fboundp 'hive-mcp-swarm-events-emit-prompt-shown)
    (hive-mcp-swarm-events-emit-prompt-shown slave-id prompt-text)))

(defun hive-mcp-swarm-prompts---process-human-mode (slave-id slave)
  "Process human-mode prompt detection for SLAVE with SLAVE-ID.\nQueues prompt for human decision if new and not already queued.\nReturns t if a prompt was queued, nil otherwise."
  (let* ((buffer (plist-get slave :buffer))
        (last-pos (gethash slave-id hive-mcp-swarm-prompts--last-positions 0)))
    (when (hive-mcp-swarm-prompts---slave-active-p slave buffer)
    (let* ((prompt-info (hive-mcp-swarm-prompts---extract-prompt buffer)))
    (when (and prompt-info (hive-mcp-swarm-prompts---prompt-is-new-p (plist-get prompt-info :pos) last-pos) (not (hive-mcp-swarm-prompts---already-queued-p slave-id)))
    (puthash slave-id (plist-get prompt-info :pos) hive-mcp-swarm-prompts--last-positions)
    (hive-mcp-swarm-prompts---queue-prompt slave-id (plist-get prompt-info :text) buffer)
    t)))))

(defun hive-mcp-swarm-prompts---human-tick (slaves-hash)
  "Check all slave buffers for prompts in human mode.\nSLAVES-HASH is hash table of slave-id -> slave plist."
  (maphash (lambda (slave-id slave)
    (hive-mcp-swarm-prompts---process-human-mode slave-id slave)) slaves-hash))

(defun hive-mcp-swarm-prompts---send-response (buffer response)
  "Send RESPONSE to slave BUFFER."
  (when (buffer-live-p buffer)
    (let* ((term-type (with-current-buffer buffer
    (cond
  (((derived-mode-p 'vterm-mode) 'vterm) ((derived-mode-p 'eat-mode) 'eat))))))
    (pcase term-type
  ((quote vterm) (with-current-buffer buffer
    (vterm-send-string response)
    (sit-for 0.05)
    (vterm-send-return)))
  ((quote eat) (with-current-buffer buffer
    (when (and (boundp 'eat-terminal) eat-terminal)
    (eat-term-send-string eat-terminal response)
    (eat-term-send-string eat-terminal "\r"))))))))

(defun hive-mcp-swarm-prompts-update-buffer ()
  "Refresh the prompts buffer with current pending prompts."
  (when-let-star (list buf (get-buffer hive-mcp-swarm-prompts-buffer-name)) (with-current-buffer buf
    (erase-buffer)
    (insert (format "=== Pending Swarm Prompts (%d) ===\n" (length hive-mcp-swarm-prompts--pending)))
    (if hive-mcp-swarm-prompts--pending (dolist (prompt (reverse hive-mcp-swarm-prompts--pending))
    (insert (format "\n[%s] %s\n  %s\n" (format-time-string "%H:%M:%S" (plist-get prompt :timestamp)) (plist-get prompt :slave-id) (plist-get prompt :prompt)))) (insert "\nNo pending prompts.\n")))))

(defun hive-mcp-swarm-prompts-respond ()
  "Respond to the next pending prompt interactively."
  (interactive)
  (if-let-star (list prompt (car hive-mcp-swarm-prompts--pending)) (let* ((slave-id (plist-get prompt :slave-id))
        (text (plist-get prompt :prompt))
        (response (clel-read-string (format "[%s] %s -> " slave-id text))))
    (pop hive-mcp-swarm-prompts--pending)
    (hive-mcp-swarm-prompts---send-response (plist-get prompt :buffer) response)
    (hive-mcp-swarm-prompts-update-buffer)
    (message "[swarm-prompts] Sent response to %s" slave-id)) (message "[swarm-prompts] No pending prompts")))

(defun hive-mcp-swarm-prompts-approve ()
  "Approve (send 'y') to the next pending prompt."
  (interactive)
  (if-let-star (list prompt (pop hive-mcp-swarm-prompts--pending)) (progn
  (hive-mcp-swarm-prompts---send-response (plist-get prompt :buffer) "y")
  (hive-mcp-swarm-prompts-update-buffer)
  (message "[swarm-prompts] Approved: %s" (plist-get prompt :slave-id))) (message "[swarm-prompts] No pending prompts")))

(defun hive-mcp-swarm-prompts-deny ()
  "Deny (send 'n') to the next pending prompt."
  (interactive)
  (if-let-star (list prompt (pop hive-mcp-swarm-prompts--pending)) (progn
  (hive-mcp-swarm-prompts---send-response (plist-get prompt :buffer) "n")
  (hive-mcp-swarm-prompts-update-buffer)
  (message "[swarm-prompts] Denied: %s" (plist-get prompt :slave-id))) (message "[swarm-prompts] No pending prompts")))

(defun hive-mcp-swarm-prompts-list ()
  "List all pending prompts in the prompts buffer."
  (interactive)
  (hive-mcp-swarm-prompts-update-buffer)
  (display-buffer (get-buffer-create hive-mcp-swarm-prompts-buffer-name)))

(defun hive-mcp-swarm-prompts-get-pending ()
  "Get list of pending prompts."
  hive-mcp-swarm-prompts--pending)

(defun hive-mcp-swarm-prompts-find-pending (slave-id)
  "Find pending prompt for SLAVE-ID."
  (cl-find slave-id hive-mcp-swarm-prompts--pending :key (lambda (p)
    (plist-get p :slave-id)) :test #'equal))

(defun hive-mcp-swarm-prompts-respond-to (slave-id response)
  "Send RESPONSE to pending prompt from SLAVE-ID.\nReturns t on success, nil if no pending prompt found."
  (if-let-star (list prompt (hive-mcp-swarm-prompts-find-pending slave-id)) (let* ((buffer (plist-get prompt :buffer)))
    (setq hive-mcp-swarm-prompts--pending (cl-remove slave-id hive-mcp-swarm-prompts--pending :key (lambda (p)
    (plist-get p :slave-id)) :test #'equal))
    (hive-mcp-swarm-prompts---send-response buffer response)
    (hive-mcp-swarm-prompts-update-buffer)
    t) nil))

(defun hive-mcp-swarm-prompts-clear-slave (slave-id)
  "Clear last position tracking for SLAVE-ID."
  (remhash slave-id hive-mcp-swarm-prompts--last-positions))

(defun hive-mcp-swarm-prompts-start-watcher (slaves-hash get-terminal-fn)
  "Start the prompt watcher timer.\nSLAVES-HASH is the hash table of slaves to monitor.\nGET-TERMINAL-FN extracts terminal type from slave plist."
  (hive-mcp-swarm-prompts-stop-watcher)
  (setq hive-mcp-swarm-prompts--timer (run-with-timer 1 2 (lambda (_unused)
    (condition-case err
    (pcase hive-mcp-swarm-prompts-mode
  ((quote bypass) nil)
  ((quote auto) (hive-mcp-swarm-prompts---auto-tick slaves-hash get-terminal-fn))
  ((quote human) (hive-mcp-swarm-prompts---human-tick slaves-hash)))
  (error (message "[swarm-prompts] Watcher tick error: %s" (error-message-string err)))))))
  (message "[swarm-prompts] Watcher started (mode: %s)" hive-mcp-swarm-prompts-mode))

(defun hive-mcp-swarm-prompts-stop-watcher ()
  "Stop the prompt watcher timer."
  (when hive-mcp-swarm-prompts--timer
    (cancel-timer hive-mcp-swarm-prompts--timer)
    (setq hive-mcp-swarm-prompts--timer nil)
    (message "[swarm-prompts] Watcher stopped")))

(defun hive-mcp-swarm-prompts-init ()
  "Initialize prompts module."
  (clrhash hive-mcp-swarm-prompts--last-positions)
  (setq hive-mcp-swarm-prompts--pending nil))

(defun hive-mcp-swarm-prompts-shutdown ()
  "Shutdown prompts module."
  (hive-mcp-swarm-prompts-stop-watcher)
  (clrhash hive-mcp-swarm-prompts--last-positions)
  (setq hive-mcp-swarm-prompts--pending nil))

(provide 'hive-mcp-swarm-prompts)
;;; hive-mcp-swarm-prompts.el ends here
