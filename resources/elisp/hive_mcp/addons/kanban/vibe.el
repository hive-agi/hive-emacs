;;; hive-mcp-kanban-vibe.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'cl-lib)
(require 'json)
(require 'hive-mcp-kanban-protocol)

;;; Code:



(defcustom default-project nil
  "Default vibe-kanban project ID.\nSet this to your project UUID for automatic project selection."
  :group 'hive-mcp-kanban
  :type '(choice (const :tag "None" nil) (string :tag "Project UUID")))

(defvar hive-mcp-kanban-vibe--cache nil
  "Cache for vibe-kanban data.")

(defun hive-mcp-kanban-vibe---mcp-call (tool params)
  "Call vibe-kanban MCP TOOL with PARAMS.\nThis uses emacsclient to communicate with the MCP server."
  (let* ((cmd (format "(mcp__vibe_kanban__%s %s)" tool (if params (json-encode params) ""))))
    (message "MCP call: %s" cmd)
    nil))

(cl-defmethod hive-mcp-kanban-protocol--list-projects (list (_backend (eql vibe))) "List projects from vibe-kanban MCP." (hive-mcp-kanban-vibe--mcp-call "list_projects" nil))

(cl-defmethod hive-mcp-kanban-protocol--list-tasks (list (_backend (eql vibe)) project-id &optional status) "List tasks from vibe-kanban for PROJECT-ID, optionally filtered by STATUS." (let* ((params (backquote ((project_id - project-id)))))
    (when status
    (push (backquote (status - status)) params))
    (hive-mcp-kanban-vibe--mcp-call "list_tasks" params)))

(cl-defmethod hive-mcp-kanban-protocol--get-task (list (_backend (eql vibe)) task-id) "Get TASK-ID from vibe-kanban." (hive-mcp-kanban-vibe--mcp-call "get_task" (backquote ((task_id - task-id)))))

(cl-defmethod hive-mcp-kanban-protocol--create-task (list (_backend (eql vibe)) project-id title &optional description) "Create task with TITLE in PROJECT-ID, optionally with DESCRIPTION." (let* ((params (backquote ((project_id - project-id) (title - title)))))
    (when description
    (push (backquote (description - description)) params))
    (hive-mcp-kanban-vibe--mcp-call "create_task" params)))

(cl-defmethod hive-mcp-kanban-protocol--update-task (list (_backend (eql vibe)) task-id &rest props) "Update TASK-ID in vibe-kanban with PROPS." (let* ((params (backquote ((task_id - task-id)))))
    (when-let-star (list title (plist-get props :title)) (push (backquote (title - title)) params))
    (when-let-star (list desc (plist-get props :description)) (push (backquote (description - desc)) params))
    (when-let-star (list status (plist-get props :status)) (push (backquote (status - status)) params))
    (hive-mcp-kanban-vibe--mcp-call "update_task" params)))

(cl-defmethod hive-mcp-kanban-protocol--delete-task (list (_backend (eql vibe)) task-id) "Delete TASK-ID from vibe-kanban." (hive-mcp-kanban-vibe--mcp-call "delete_task" (backquote ((task_id - task-id)))))

(defun hive-mcp-kanban-vibe-clear-cache ()
  "Clear the vibe-kanban cache."
  (interactive)
  (setq hive-mcp-kanban-vibe--cache nil)
  (message "Vibe-kanban cache cleared"))

(defun hive-mcp-kanban-vibe-refresh-cache (project-id)
  "Refresh cache for PROJECT-ID from vibe-kanban."
  (let* ((tasks (hive-mcp-kanban-vibe--mcp-call "list_tasks" (backquote ((project_id - project-id))))))
    (setq hive-mcp-kanban-vibe--cache (plist-put hive-mcp-kanban-vibe--cache (intern project-id) (backquote ((tasks - tasks) (timestamp - (current-time))))))
    tasks))

(provide 'hive-mcp-kanban-vibe)
;;; hive-mcp-kanban-vibe.el ends here
