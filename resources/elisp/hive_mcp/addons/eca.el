;;; hive-mcp-eca.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)
(require 'hive-mcp-api)

;;; Code:



(defgroup hive-mcp-eca nil
  "Integration between hive-mcp and ECA."
  :group 'hive-mcp
  :prefix "hive-mcp-eca-")

(defcustom hive-mcp-eca-auto-context nil
  "When non-nil, automatically include MCP context in ECA chats."
  :group 'hive-mcp-eca
  :type 'boolean)

(defvar hive-mcp-eca--initialized nil
  "Whether the addon has been initialized.")

(defun hive-mcp-eca-ensure-api ()
  "Ensure hive-mcp-api is available."
  (if (featurep 'hive-mcp-api) nil (progn
  (require 'hive-mcp-api nil t)))
  (featurep 'hive-mcp-api))

(defun hive-mcp-eca-get-context ()
  "Get MCP context for ECA."
  (when (hive-mcp-eca-ensure-api)
    (hive-mcp-api-get-context)))

(defun hive-mcp-eca-start-eca ()
  "Start or switch to ECA session."
  (interactive)
  (eca))

(defun hive-mcp-eca-stop-eca ()
  "Stop ECA session."
  (interactive)
  (eca-stop))

(defun hive-mcp-eca-restart-eca ()
  "Restart ECA session."
  (interactive)
  (eca-restart))

(defun hive-mcp-eca-chat-send (message)
  "Send MESSAGE to current ECA chat."
  (when-let ((session (eca-session)))
    (eca-chat-send session message)))

(defun hive-mcp-eca-chat-open ()
  "Open ECA chat buffer."
  (interactive)
  (when-let ((session (eca-session)))
    (eca-chat-open session)))

(defun hive-mcp-eca-save-to-memory (content type &optional tags)
  "Save CONTENT to hive-mcp memory as TYPE with optional TAGS."
  (interactive (list (if (use-region-p) (buffer-substring-no-properties (region-beginning) (region-end)) (clel-read-string "Content: ")) (completing-read "Type: " '("note" "snippet" "decision") nil t) (split-string (clel-read-string "Tags (comma-separated): ") "," t " ")))
  (when (hive-mcp-eca-ensure-api)
    (hive-mcp-api-memory-add type content tags)
    (message "Saved to memory as %s" type)))

(defun hive-mcp-eca-query-memory (type &optional limit)
  "Query hive-mcp memory for entries of TYPE."
  (when (hive-mcp-eca-ensure-api)
    (hive-mcp-api-memory-query type nil (or limit 10))))

(defun hive-mcp-eca-inject-context ()
  "Inject MCP context into current ECA chat."
  (interactive)
  (when-let ((ctx (hive-mcp-eca-get-context)))
    (hive-mcp-eca-chat-send (format "Context:\n%s" ctx))))

(defun hive-mcp-eca--enable ()
  "Enable hive-mcp-eca integration."
  (add-hook 'eca-after-initialize-hook #'hive-mcp-eca--on-eca-init)
  (setq hive-mcp-eca--initialized t)
  (message "hive-mcp-eca enabled"))

(defun hive-mcp-eca--disable ()
  "Disable hive-mcp-eca integration."
  (remove-hook 'eca-after-initialize-hook #'hive-mcp-eca--on-eca-init)
  (setq hive-mcp-eca--initialized nil)
  (message "hive-mcp-eca disabled"))

(defun hive-mcp-eca--on-eca-init ()
  "Hook run after ECA initializes."
  (when hive-mcp-eca-auto-context
    (hive-mcp-eca-inject-context)))

(define-minor-mode hive-mcp-eca-mode
  "Minor mode for hive-mcp integration with ECA."
  :init-value nil
  :lighter " MCP-ECA"
  :global t
  :group 'hive-mcp-eca
  (if hive-mcp-eca-mode (hive-mcp-eca--enable) (hive-mcp-eca--disable)))

(defun hive-mcp-eca--addon-init ()
  "Initialize the hive-mcp-eca addon."
  (require 'hive-mcp-api nil t)
  (message "hive-mcp-eca: initialized"))

(defun hive-mcp-eca--addon-shutdown ()
  "Shutdown the hive-mcp-eca addon."
  (when hive-mcp-eca-mode
    (hive-mcp-eca-mode -1))
  (message "hive-mcp-eca: shutdown"))

(with-eval-after-load 'hive-mcp-addons
  (hive-mcp-addon-register 'eca :version "0.1.0" :description "ECA integration" :requires '(hive-mcp-api) :provides '(hive-mcp-eca-mode) :init #'-addon-init :shutdown #'-addon-shutdown))

(provide 'hive-mcp-eca)

(provide 'hive-mcp-eca)
;;; hive-mcp-eca.el ends here
