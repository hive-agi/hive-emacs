;;; hive-mcp-api.el --- -*- lexical-binding: t; -*-
;; Generated by ClojureElisp

(require 'clojure-elisp-runtime)

;;; Code:



(require 'hive-mcp-memory)

(require 'hive-mcp-kanban)

(require 'hive-mcp-context)

(require 'hive-mcp-graceful)

(require 'hive-mcp-transform)

(declare-function hive-mcp-workflow-list "hive-mcp-workflows")

(declare-function hive-mcp-workflow-run "hive-mcp-workflows")

(declare-function hive-mcp-workflow-register "hive-mcp-workflows")

(declare-function hive-mcp-register-trigger "hive-mcp-triggers")

(declare-function hive-mcp-list-triggers "hive-mcp-triggers")

(defconst hive-mcp-api--valid-memory-types '("note" "snippet" "convention" "decision" "conversation") "Valid memory entry types.")

(defconst hive-mcp-api--valid-memory-durations '("ephemeral" "short" "medium" "long" "permanent" "session" "short-term" "long-term") "Valid memory duration values.")

(defconst hive-mcp-api--valid-kanban-statuses '("todo" "doing" "review" "done") "Valid kanban task statuses.")

(defconst hive-mcp-api--valid-kanban-priorities '("high" "medium" "low") "Valid kanban task priorities.")

(defconst hive-mcp-api--valid-notification-types '("info" "warning" "error") "Valid notification types.")

(defconst hive-mcp-api--valid-conversation-roles '("user" "assistant") "Valid conversation roles.")

(defconst hive-mcp-api--max-content-length 100000 "Maximum content length for memory entries (100KB).")

(defconst hive-mcp-api--max-timeout-ms 600000 "Maximum timeout in milliseconds (10 minutes).")

(defun hive-mcp-api---validate-string (value name &optional allow-empty max-length)
  "Validate VALUE is a non-empty string.\nNAME is used in error messages.\nIf ALLOW-EMPTY is non-nil, empty strings are accepted.\nMAX-LENGTH limits string length if provided.\nReturns VALUE if valid, signals error otherwise."
  (unless (stringp value)
    (error "CLARITY-I: %s must be a string, got %s" name (type-of value)))
  (when (and (not allow-empty) (string-empty-p value))
    (error "CLARITY-I: %s cannot be empty" name))
  (when (and max-length (> (length value) max-length))
    (error "CLARITY-I: %s exceeds maximum length of %d" name max-length))
  value)

(defun hive-mcp-api---validate-string-or-nil (value name &optional max-length)
  "Validate VALUE is a string or nil.\nNAME is used in error messages.\nMAX-LENGTH limits string length if provided.\nReturns VALUE if valid, signals error otherwise."
  (when value
    (hive-mcp-api--validate-string value name t max-length))
  value)

(defun hive-mcp-api---validate-positive-integer (value name &optional max-value)
  "Validate VALUE is a positive integer.\nNAME is used in error messages.\nMAX-VALUE is optional upper bound.\nReturns VALUE if valid, signals error otherwise."
  (unless (integerp value)
    (error "CLARITY-I: %s must be an integer, got %s" name (type-of value)))
  (when (< value 1)
    (error "CLARITY-I: %s must be positive, got %d" name value))
  (when (and max-value (> value max-value))
    (error "CLARITY-I: %s exceeds maximum of %d, got %d" name max-value value))
  value)

(defun hive-mcp-api---validate-non-negative-integer (value name &optional max-value)
  "Validate VALUE is a non-negative integer (0 or positive).\nNAME is used in error messages.\nMAX-VALUE is optional upper bound.\nReturns VALUE if valid, signals error otherwise."
  (unless (integerp value)
    (error "CLARITY-I: %s must be an integer, got %s" name (type-of value)))
  (when (< value 0)
    (error "CLARITY-I: %s must be non-negative, got %d" name value))
  (when (and max-value (> value max-value))
    (error "CLARITY-I: %s exceeds maximum of %d, got %d" name max-value value))
  value)

(defun hive-mcp-api---validate-enum (value valid-values name)
  "Validate VALUE is one of VALID-VALUES.\nNAME is used in error messages.\nReturns VALUE if valid, signals error otherwise."
  (unless (stringp value)
    (error "CLARITY-I: %s must be a string, got %s" name (type-of value)))
  (unless (member value valid-values)
    (error "CLARITY-I: %s must be one of %s, got \"%s\"" name (mapconcat #'identity valid-values ", ") value))
  value)

(defun hive-mcp-api---validate-memory-type (type)
  "Validate TYPE is a valid memory type.\nReturns TYPE if valid, signals error otherwise."
  (hive-mcp-api--validate-enum type hive-mcp-api--valid-memory-types "memory type"))

(defun hive-mcp-api---validate-memory-duration (duration)
  "Validate DURATION is a valid memory duration.\nReturns DURATION if valid, signals error otherwise."
  (hive-mcp-api--validate-enum duration hive-mcp-api--valid-memory-durations "memory duration"))

(defun hive-mcp-api---validate-kanban-status (status)
  "Validate STATUS is a valid kanban status.\nReturns STATUS if valid, signals error otherwise."
  (hive-mcp-api--validate-enum status hive-mcp-api--valid-kanban-statuses "kanban status"))

(defun hive-mcp-api---validate-kanban-priority (priority)
  "Validate PRIORITY is a valid kanban priority.\nReturns PRIORITY if valid, signals error otherwise."
  (hive-mcp-api--validate-enum priority hive-mcp-api--valid-kanban-priorities "kanban priority"))

(defun hive-mcp-api---validate-notification-type (type)
  "Validate TYPE is a valid notification type.\nReturns TYPE if valid, signals error otherwise."
  (hive-mcp-api--validate-enum type hive-mcp-api--valid-notification-types "notification type"))

(defun hive-mcp-api---validate-conversation-role (role)
  "Validate ROLE is a valid conversation role.\nReturns ROLE if valid, signals error otherwise."
  (hive-mcp-api--validate-enum role hive-mcp-api--valid-conversation-roles "conversation role"))

(defun hive-mcp-api---validate-id (id)
  "Validate ID is a valid identifier string.\nMust be non-empty string, alphanumeric with hyphens/underscores.\nReturns ID if valid, signals error otherwise."
  (hive-mcp-api--validate-string id "id")
  (unless (string-match-p "^[a-zA-Z0-9_-]+$" id)
    (error "CLARITY-I: id must be alphanumeric with hyphens/underscores, got \"%s\"" id))
  id)

(defun hive-mcp-api---validate-content (content)
  "Validate CONTENT is valid memory content.\nMust be a string or plist, within size limits.\nReturns CONTENT if valid, signals error otherwise."
  (cond
  ((stringp content) (progn
  (when (> (length content) hive-mcp-api--max-content-length)
    (error "CLARITY-I: content exceeds maximum length of %d" hive-mcp-api--max-content-length))
  content))
  ((listp content) (let* ((serialized (prin1-to-string content)))
    (when (> (length serialized) hive-mcp-api--max-content-length)
    (error "CLARITY-I: content exceeds maximum length of %d" hive-mcp-api--max-content-length))
    content))
  (t (error "CLARITY-I: content must be a string or list, got %s" (type-of content)))))

(defun hive-mcp-api---validate-timeout (timeout-ms)
  "Validate TIMEOUT-MS is a valid timeout value.\nMust be positive integer not exceeding max timeout.\nReturns TIMEOUT-MS if valid, signals error otherwise."
  (hive-mcp-api--validate-positive-integer timeout-ms "timeout" hive-mcp-api--max-timeout-ms))

(defun hive-mcp-api---validate-limit (limit)
  "Validate LIMIT is a valid result limit.\nMust be positive integer, max 1000.\nReturns LIMIT if valid, signals error otherwise."
  (hive-mcp-api--validate-positive-integer limit "limit" 1000))

(defun hive-mcp-api---validate-list-of-strings (value name)
  "Validate VALUE is a list of strings.\nNAME is used in error messages.\nReturns VALUE if valid, signals error otherwise."
  (unless (listp value)
    (error "CLARITY-I: %s must be a list, got %s" name (type-of value)))
  (dolist (item value)
    (unless (stringp item)
    (error "CLARITY-I: %s must contain only strings, found %s" name (type-of item))))
  value)

(defun hive-mcp-api---validate-tags (tags)
  "Validate TAGS is a valid list of tag strings.\nReturns TAGS if valid, signals error otherwise."
  (when tags
    (hive-mcp-api--validate-list-of-strings tags "tags"))
  tags)

(defun hive-mcp-api---sanitize-prompt (prompt)
  "Sanitize PROMPT string for safe use.\nTrims whitespace, removes control characters (except newlines).\nReturns sanitized string."
  (hive-mcp-api--validate-string prompt "prompt")
  (let* ((sanitized (string-trim prompt)))
    (replace-regexp-in-string "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]" "" sanitized)))

(defun hive-mcp-api-get-context ()
  "Return full context as JSON-compatible plist.\nIncludes buffer, region, defun, project, git, and memory.\nReturns partial context on errors - never fails completely."
  (condition-case err-5029
    (let* ((ctx (hive-mcp-context-full)))
    (plist-put ctx :memory (condition-case err-5030
    (hive-mcp-memory-get-project-context)
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5030)
      nil)))
    ctx)
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5029)
      (list :error "context-unavailable" :buffer (buffer-name) :point (point)))))

(defun hive-mcp-api-get-buffer-context ()
  "Return current buffer context."
  (hive-mcp-context-buffer))

(defun hive-mcp-api-get-region ()
  "Return selected region text and metadata, or nil."
  (hive-mcp-context-region))

(defun hive-mcp-api-get-defun ()
  "Return current function context."
  (hive-mcp-context-defun))

(defun hive-mcp-api-get-project ()
  "Return project context."
  (hive-mcp-context-project))

(defun hive-mcp-api-get-git ()
  "Return git context."
  (hive-mcp-context-git))

(defun hive-mcp-api-get-surrounding-lines (&optional before after)
  "Return lines surrounding point.\nBEFORE and AFTER default to 5 lines each."
  (hive-mcp-context-surrounding-lines before after))

(defun hive-mcp-api-memory-query (type &optional tags limit scope-filter)
  "Query project memory by TYPE with optional TAGS filter.\nTYPE is a string: \"note\", \"snippet\", \"convention\", \"decision\",\nor \"conversation\".\nTAGS is a list of strings.\nLIMIT is max results (default 20).\nSCOPE-FILTER controls scope filtering:\n  - nil or omitted: auto-filter by current project scope + global\n  - \"all\": return all entries regardless of scope\n  - \"global\": return only scope:global entries\n  - specific scope tag string: filter by that scope\nReturns a vector of alists suitable for JSON encoding.\nReturns empty vector on error."
  (hive-mcp-api--validate-memory-type type)
  (hive-mcp-api--validate-tags tags)
  (when limit
    (hive-mcp-api--validate-limit limit))
  (condition-case err-5031
    (let* ((scope-arg (hive-mcp-transform-scope-arg scope-filter))
        (results (hive-mcp-memory-query (intern type) tags nil (or limit 20) nil scope-arg)))
    (hive-mcp-transform-entries-to-vector results))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5031)
      (list ))))

(defun hive-mcp-api-memory-add (type content &optional tags duration)
  "Add entry to project memory.\nTYPE is a string: \"note\", \"snippet\", \"convention\", \"decision\".\nCONTENT is the entry content (string or plist).\nTAGS is optional list of strings.\nDURATION is optional string: \"session\", \"short-term\", \"long-term\", \"permanent\".\nReturns the created entry as alist suitable for JSON encoding.\nReturns error alist on failure."
  (hive-mcp-api--validate-memory-type type)
  (hive-mcp-api--validate-content content)
  (hive-mcp-api--validate-tags tags)
  (when duration
    (hive-mcp-api--validate-memory-duration duration))
  (condition-case err-5032
    (let* ((entry (hive-mcp-memory-add (intern type) content tags nil (when duration
    (intern duration)))))
    (hive-mcp-transform-plist-to-alist entry))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5032)
      (hive-mcp-transform-error-result "memory-add-failed" 'type nil 'id nil))))

(defun hive-mcp-api-memory-get (id)
  "Get memory entry by ID."
  (hive-mcp-api--validate-id id)
  (hive-mcp-memory-get id))

(defun hive-mcp-api-memory-update (id updates)
  "Update memory entry ID with UPDATES plist."
  (hive-mcp-api--validate-id id)
  (hive-mcp-memory-update id updates))

(defun hive-mcp-api-memory-delete (id)
  "Delete memory entry by ID."
  (hive-mcp-api--validate-id id)
  (hive-mcp-memory-delete id))

(defun hive-mcp-api-memory-query-metadata (type &optional tags limit scope-filter)
  "Query project memory by TYPE, returning only metadata.\nTYPE is a string: \"note\", \"snippet\", \"convention\", \"decision\",\nor \"conversation\".\nTAGS is a list of strings.\nLIMIT is max results (default 20).\nSCOPE-FILTER: see `hive-mcp-api-memory-query' for options.\nReturns a vector of alists with only: id, type, preview, tags, created.\nUse `hive-mcp-api-memory-get-full' to fetch full content by ID."
  (hive-mcp-api--validate-memory-type type)
  (hive-mcp-api--validate-tags tags)
  (when limit
    (hive-mcp-api--validate-limit limit))
  (let* ((scope-arg (hive-mcp-transform-scope-arg scope-filter))
        (results (hive-mcp-memory-query (intern type) tags nil (or limit 20) nil scope-arg)))
    (apply #'vector (mapcar #'hive-mcp-transform-entry-to-metadata results))))

(defun hive-mcp-api-get-project-name ()
  "Return the current project name, or nil if not in a project."
  (hive-mcp-memory--get-project-name))

(defun hive-mcp-api-get-applicable-scopes (&optional domain)
  "Return list of scope tags applicable to current context.\nDOMAIN is optional domain name to include.\nAlways includes scope:global and current project scope if in a project."
  (hive-mcp-memory--applicable-scope-tags nil domain))

(defun hive-mcp-api-memory-get-full (id)
  "Get full memory entry by ID.\nReturns the complete entry as alist suitable for JSON encoding.\nUse this after `hive-mcp-api-memory-query-metadata' to fetch full content."
  (hive-mcp-api--validate-id id)
  (when-let-star (list entry (hive-mcp-memory-get id)) (hive-mcp-transform-plist-to-alist entry)))

(defun hive-mcp-api-memory-get-project-context ()
  "Return full project context including all memory."
  (hive-mcp-memory-get-project-context))

(defun hive-mcp-api-memory-check-duplicate (type content)
  "Check if CONTENT already exists in memory TYPE.\nTYPE is a string: \"note\", \"snippet\", \"convention\", \"decision\".\nCONTENT is the content to check.\nReturns an alist with:\n  - exists: t if duplicate found, nil otherwise\n  - entry: the existing entry (as alist) if found, nil otherwise\n  - content-hash: the computed hash for the content"
  (hive-mcp-api--validate-memory-type type)
  (hive-mcp-api--validate-content content)
  (let* ((type-sym (if (stringp type) (intern type) type))
        (content-hash (hive-mcp-memory-content-hash content))
        (existing (hive-mcp-memory-find-duplicate type-sym content)))
    (hive-mcp-transform-duplicate-result existing existing content-hash)))

(defun hive-mcp-api-memory-content-hash (content)
  "Compute content hash for CONTENT.\nReturns the SHA-256 hash as a string."
  (hive-mcp-memory-content-hash content))

(defun hive-mcp-api-memory-set-duration (id duration)
  "Set DURATION (string) for entry ID. Returns updated entry as alist."
  (hive-mcp-api--validate-id id)
  (hive-mcp-api--validate-memory-duration duration)
  (hive-mcp-memory-set-duration id (intern duration))
  (hive-mcp-transform-plist-to-alist (hive-mcp-memory-get id)))

(defun hive-mcp-api-memory-promote (id)
  "Promote entry ID to longer duration. Returns updated entry."
  (hive-mcp-api--validate-id id)
  (hive-mcp-memory-promote id)
  (hive-mcp-transform-plist-to-alist (hive-mcp-memory-get id)))

(defun hive-mcp-api-memory-demote (id)
  "Demote entry ID to shorter duration. Returns updated entry."
  (hive-mcp-api--validate-id id)
  (hive-mcp-memory-demote id)
  (hive-mcp-transform-plist-to-alist (hive-mcp-memory-get id)))

(defun hive-mcp-api-memory-cleanup-expired ()
  "Remove expired entries. Returns count deleted."
  (hive-mcp-memory-cleanup-expired))

(defun hive-mcp-api-memory-expiring-soon (days)
  "Return entries expiring within DAYS as vector of alists."
  (hive-mcp-api--validate-positive-integer days "days")
  (let* ((results (hive-mcp-memory-query-expiring days)))
    (hive-mcp-transform-entries-to-vector results)))

(defun hive-mcp-api-conversation-log (role content)
  "Log conversation entry.\nROLE is \"user\" or \"assistant\".\nCONTENT is the message content."
  (hive-mcp-api--validate-conversation-role role)
  (hive-mcp-api--validate-content content)
  (hive-mcp-memory-log-conversation (intern role) content))

(defun hive-mcp-api-conversation-history (&optional limit)
  "Get recent conversation history.\nLIMIT defaults to 20 entries."
  (when limit
    (hive-mcp-api--validate-limit limit))
  (hive-mcp-memory-query 'conversation nil nil (or limit 20)))

(defun hive-mcp-api-conversation-clear ()
  "Clear conversation history for current project."
  (let* ((pid (hive-mcp-memory--project-id)))
    (hive-mcp-memory--set-data pid "conversation" '())
    t))

(defun hive-mcp-api-list-workflows ()
  "Return list of registered workflows."
  (if (fboundp 'hive-mcp-workflow-list) (hive-mcp-workflow-list) '()))

(defun hive-mcp-api-run-workflow (name &optional args)
  "Run workflow by NAME with optional ARGS plist.\nReturns error alist on failure instead of signaling."
  (condition-case err-5033
    (if (fboundp 'hive-mcp-workflow-run) (hive-mcp-workflow-run name args) '((error . "workflows-not-available")))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5033)
      (hive-mcp-transform-error-result "workflow-execution-failed" 'workflow name))))

(defun hive-mcp-api-register-workflow (name spec)
  "Register a new workflow.\nNAME is the workflow name.\nSPEC is plist with :description, :steps, :params."
  (if (fboundp 'hive-mcp-workflow-register) (hive-mcp-workflow-register name spec) (error "Workflows not available")))

(declare-function hive-mcp-workflow-wrap "hive-mcp-workflows")

(declare-function hive-mcp-workflow-catchup "hive-mcp-workflows")

(defun hive-mcp-api-workflow-wrap (&optional accomplishments decisions conventions in-progress next-actions completed-tasks)
  "Run the wrap workflow with session data.\nACCOMPLISHMENTS - list of completed tasks (stored as note, short-term)\nDECISIONS - list of decisions made (stored as decision, long-term)\nCONVENTIONS - list of conventions (stored as convention, permanent)\nIN-PROGRESS - list of in-progress items (for summary)\nNEXT-ACTIONS - list of priorities for next session (for summary)\nCOMPLETED-TASKS - list of kanban task IDs to mark done\n\nAll stored entries auto-inject project scope.\nReturns structured result suitable for JSON encoding."
  (condition-case err-5034
    (if (fboundp 'hive-mcp-workflow-wrap) (let* ((result (hive-mcp-workflow-wrap (list :accomplishments accomplishments :decisions decisions :conventions conventions :in-progress in-progress :next-actions next-actions :completed-tasks completed-tasks))))
    (hive-mcp-transform-plist-to-alist result)) '((error . "wrap-workflow-not-available")))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5034)
      '((error . "wrap-workflow-failed")))))

(defun hive-mcp-api-workflow-catchup ()
  "Run the catchup workflow to restore session context.\nQueries session notes, decisions, and conventions with project scope.\nReturns structured result suitable for JSON encoding."
  (condition-case err-5035
    (if (fboundp 'hive-mcp-workflow-catchup) (let* ((result (hive-mcp-workflow-catchup)))
    (hive-mcp-transform-plist-to-alist result)) '((error . "catchup-workflow-not-available")))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5035)
      '((error . "catchup-workflow-failed")))))

(declare-function hive-mcp-workflow-wrap--gather-session-data "hive-mcp-workflows" (&optional directory))

(defun hive-mcp-api-wrap-gather (&optional directory)
  "Gather session data for wrap workflow.\nDIRECTORY overrides `default-directory' for git operations.\nReturns plist with gathered data from memory, git, kanban, and channel.\nUse before wrap to preview/confirm data before storing."
  (condition-case err-5036
    (if (fboundp 'hive-mcp-workflow-wrap--gather-session-data) (let* ((result (hive-mcp-workflow-wrap--gather-session-data directory)))
    (hive-mcp-transform-plist-to-alist result)) '((error . "wrap-gather-not-available")))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5036)
      '((error . "wrap-gather-failed")))))

(defun hive-mcp-api-register-trigger (name spec)
  "Register a trigger for automation.\nNAME is the trigger name.\nSPEC is plist with :event, :condition, :action."
  (if (fboundp 'hive-mcp-register-trigger) (hive-mcp-register-trigger name spec) (error "Triggers not available")))

(defun hive-mcp-api-list-triggers ()
  "Return list of registered triggers."
  (if (fboundp 'hive-mcp-list-triggers) (hive-mcp-list-triggers) '()))

(defun hive-mcp-api-notify (message &optional type)
  "Show notification MESSAGE to user.\nTYPE is \"info\", \"warning\", or \"error\"."
  (hive-mcp-api--validate-string message "message")
  (when type
    (hive-mcp-api--validate-notification-type type))
  (pcase type
  ("error" (user-error "%s" message))
  ("warning" (display-warning 'hive-mcp message :warning))
  ('_ (message "[MCP] %s" message)))
  t)

(defun hive-mcp-api-prompt (prompt &optional default)
  "Show PROMPT and ask user for input.\nDEFAULT provides an optional initial value.\nReturns the user's response string."
  (let* ((safe-prompt (hive-mcp-api--sanitize-prompt prompt)))
    (hive-mcp-api--validate-string-or-nil default "default")
    (clel-read-string (concat safe-prompt ": ") default)))

(defun hive-mcp-api-confirm (prompt)
  "Show PROMPT and ask user for yes/no confirmation.\nReturns t or nil."
  (let* ((safe-prompt (hive-mcp-api--sanitize-prompt prompt)))
    (yes-or-no-p safe-prompt)))

(defun hive-mcp-api-select (prompt options)
  "Ask user to select from OPTIONS.\nPROMPT is the prompt string.\nOPTIONS is a list of strings.\nReturns the selected option."
  (let* ((safe-prompt (hive-mcp-api--sanitize-prompt prompt)))
    (hive-mcp-api--validate-list-of-strings options "options")
    (completing-read (concat safe-prompt ": ") options nil t)))

(defun hive-mcp-api-open-file (path &optional line)
  "Open file at PATH and optionally go to LINE.\nReturns t on success, error alist on failure."
  (hive-mcp-api--validate-string path "path")
  (when line
    (hive-mcp-api--validate-positive-integer line "line"))
  (condition-case err-5037
    (progn
  (find-file path)
  (when line
    (goto-char (point-min))
    (forward-line (1- line)))
  t)
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5037)
      (hive-mcp-transform-error-result "file-open-failed" 'path path))))

(defun hive-mcp-api-save-buffer ()
  "Save current buffer."
  (hive-mcp-api-save-buffer)
  t)

(defun hive-mcp-api-switch-buffer (name)
  "Switch to buffer NAME."
  (hive-mcp-api--validate-string name "buffer name")
  (switch-to-buffer name)
  t)

(defun hive-mcp-api-get-buffer-list ()
  "Return list of buffer names."
  (mapcar #'buffer-name (buffer-list)))

(defun hive-mcp-api-kill-buffer (&optional name)
  "Kill buffer NAME or current buffer."
  (hive-mcp-api--validate-string-or-nil name "buffer name")
  (hive-mcp-api-kill-buffer name)
  t)

(defun hive-mcp-api-goto-line (line)
  "Go to LINE number.\nReturns alist with line and column position."
  (hive-mcp-api--validate-positive-integer line "line")
  (goto-char (point-min))
  (forward-line (1- line))
  (hive-mcp-transform-position-to-alist nil (line-number-at-pos) (current-column)))

(defun hive-mcp-api-goto-point (point)
  "Go to POINT position.\nReturns alist with point, line, and column position."
  (hive-mcp-api--validate-positive-integer point "point")
  (goto-char point)
  (hive-mcp-transform-position-to-alist (point) (line-number-at-pos) (current-column)))

(defun hive-mcp-api-search-forward (string &optional bound)
  "Search forward for STRING.\nBOUND limits the search to that buffer position.\nReturns position if found, nil otherwise."
  (hive-mcp-api--validate-string string "search string")
  (when bound
    (hive-mcp-api--validate-positive-integer bound "bound"))
  (hive-mcp-api-search-forward string bound t))

(defun hive-mcp-api-search-regexp (regexp &optional bound)
  "Search forward for REGEXP.\nBOUND limits the search to that buffer position.\nReturns position if found, nil otherwise."
  (hive-mcp-api--validate-string regexp "regexp")
  (when bound
    (hive-mcp-api--validate-positive-integer bound "bound"))
  (re-search-forward regexp bound t))

(defun hive-mcp-api-highlight-line (&optional line)
  "Highlight LINE (or current line) briefly."
  (when line
    (hive-mcp-api--validate-positive-integer line "line"))
  (save-excursion
    (when line
    (goto-char (point-min))
    (forward-line (1- line)))
    (when (fboundp 'pulse-momentary-highlight-one-line)
    (pulse-momentary-highlight-one-line (point))))
  t)

(defun hive-mcp-api-highlight-region (start end)
  "Highlight region from START to END briefly."
  (hive-mcp-api--validate-positive-integer start "start")
  (hive-mcp-api--validate-positive-integer end "end")
  (when (fboundp 'pulse-momentary-highlight-region)
    (pulse-momentary-highlight-region start end))
  t)

(defun hive-mcp-api-show-in-buffer (name content &optional mode)
  "Display CONTENT in buffer NAME with optional MODE."
  (hive-mcp-api--validate-string name "buffer name")
  (hive-mcp-api--validate-string content "content" t)
  (hive-mcp-api--validate-string-or-nil mode "mode")
  (let* ((buf (get-buffer-create name)))
    (with-current-buffer buf
    (erase-buffer)
    (insert content)
    (goto-char (point-min))
    (when (and mode (fboundp (intern mode)))
    (funcall (intern mode))))
    (display-buffer buf)
    name))

(defconst hive-mcp-api-version "0.1.0" "Version of the hive-mcp API.")

(defun hive-mcp-api-version ()
  "Return API version."
  hive-mcp-api-version)

(defun hive-mcp-api-capabilities ()
  "Return list of available API capabilities."
  (list :version hive-mcp-api-version :capabilities '("context" "memory" "conversation" "workflows" "triggers" "interaction" "navigation" "visual-feedback" "kanban") :memory-types '("note" "snippet" "convention" "decision" "conversation") :memory-durations '("session" "short-term" "long-term" "permanent") :kanban-statuses '("todo" "doing" "review" "done") :kanban-priorities '("high" "medium" "low") :workflow-step-types '("elisp" "shell" "prompt" "confirm" "condition" "memory-add" "notify")))

(defun hive-mcp-api-kanban-create (title &optional priority context directory)
  "API: Create kanban task with TITLE.\nPRIORITY is optional (default: medium). Valid: high, medium, low.\nCONTEXT is optional notes.\nDIRECTORY specifies the project directory for scoping.\nReturns created entry as alist."
  (hive-mcp-api--validate-string title "title")
  (when priority
    (hive-mcp-api--validate-kanban-priority priority))
  (hive-mcp-api--validate-string-or-nil context "context")
  (condition-case err-5038
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory)))
        (entry (hive-mcp-kanban-task-create title priority context project-id)))
    (hive-mcp-transform-plist-to-alist entry))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5038)
      (hive-mcp-transform-error-result "kanban-create-failed" 'title title))))

(defun hive-mcp-api-kanban-list (&optional status directory)
  "API: List kanban tasks.\nSTATUS filters by todo/doing/review. If nil, returns all tasks.\nDIRECTORY specifies the project directory for scoping.\nReturns vector of alists."
  (when status
    (hive-mcp-api--validate-kanban-status status))
  (condition-case err-5039
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory)))
        (entries (if status (hive-mcp-kanban-list-by-status status project-id) (hive-mcp-kanban-list-all project-id))))
    (hive-mcp-transform-entries-to-vector entries))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5039)
      (list ))))

(defun hive-mcp-api-kanban-move (task-id new-status &optional directory)
  "API: Move task TASK-ID to NEW-STATUS.\nValid statuses: todo, doing, review, done.\nIf moved to done, task is DELETED.\nDIRECTORY specifies the project directory for scoping.\nReturns updated entry as alist, or ((deleted . t)) if done."
  (hive-mcp-api--validate-id task-id)
  (hive-mcp-api--validate-kanban-status new-status)
  (condition-case err-5040
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory)))
        (result (hive-mcp-kanban-task-move task-id new-status project-id)))
    (if (eq result t) '((deleted . t) (status . "done")) (hive-mcp-transform-plist-to-alist result)))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5040)
      (hive-mcp-transform-error-result "kanban-move-failed" 'task_id task-id))))

(defun hive-mcp-api-kanban-delete (task-id &optional directory)
  "API: Delete task TASK-ID.\nDIRECTORY specifies the project directory for scoping.\nReturns ((deleted . t)) on success, ((deleted . :false)) if not found."
  (hive-mcp-api--validate-id task-id)
  (condition-case err-5041
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory))))
    (if (hive-mcp-kanban-task-delete task-id project-id) '((deleted . t)) '((deleted . :false))))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5041)
      (hive-mcp-transform-error-result "kanban-delete-failed" 'task_id task-id))))

(defun hive-mcp-api-kanban-stats (&optional directory)
  "API: Get task counts by status.\nDIRECTORY specifies the project directory for scoping.\nReturns alist with todo, doing, review counts."
  (condition-case err-5042
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory)))
        (stats (hive-mcp-kanban-stats project-id)))
    (hive-mcp-transform-stats-to-alist stats '(:todo :doing :review)))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5042)
      (hive-mcp-transform-error-result "kanban-stats-failed"))))

(defun hive-mcp-api-kanban-update (task-id &optional title priority context directory)
  "API: Update task TASK-ID with new TITLE, PRIORITY, or CONTEXT.\nOnly provided fields are updated.\nDIRECTORY specifies the project directory for scoping.\nReturns updated entry as alist."
  (hive-mcp-api--validate-id task-id)
  (hive-mcp-api--validate-string-or-nil title "title")
  (when priority
    (hive-mcp-api--validate-kanban-priority priority))
  (hive-mcp-api--validate-string-or-nil context "context")
  (condition-case err-5043
    (let* ((project-id (when directory
    (hive-mcp-memory-project-id directory)))
        (entry (hive-mcp-kanban-task-update task-id title priority context project-id)))
    (hive-mcp-transform-plist-to-alist entry))
  (error (hive-mcp-graceful--log-error "fallback triggered" err-5043)
      (hive-mcp-transform-error-result "kanban-update-failed" 'task_id task-id))))

(provide 'hive-mcp-api)

(provide 'hive-mcp-api)
;;; hive-mcp-api.el ends here
